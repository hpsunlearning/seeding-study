---
title: "Differential taxa analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, 
                      warning = FALSE, message = FALSE)
# Loading library here
library(conflicted)
library(tidyverse)
library(extrafont)
library(Ternary)
library(phyloseq)
library(colorspace)
library(patchwork)
library(ComplexHeatmap)
sessionInfo()
conflict_prefer("filter", "dplyr")

np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)


fig_path = "tmp_figs/"

col_birthmode = c("#377EB8", "#4DAF4A", "#E41A1C")
names(col_birthmode) = c("Vag", "CSseed", "CS")
```
```{r helpers}
set_panel_size <- function (p = last_plot(), g = ggplot2::ggplotGrob(p), file = NULL, margin = unit(1, "mm"), width = unit(4, "cm"), height = unit(4, "cm"), panel.size = T, msg = F, bitmap = "png", useDingbats = F, ...) {
    # This function is used to fine-tube the size of the panel
    #
    # Args:
    #   p: the ggplot object
    #   g: the ggplotGrob table for p, usually this parameter should not be changed
    #   file: file path
    #   margin: page margin, a unit object
    #   width: the exact unit object
    #   height: the exact unit object
    #   panel.size: whether the width and height is panel size or the overall graph
    #   msg: whether to print the grob table
    #   bitmap: whether to also export an exact version of bitmap: "png", "tiff", NULL
    #   ...: other ggsave parameters
    panels <- grep("panel", g$layout$name)
    panel_index_w <- unique(g$layout$l[panels])
    panel_index_h <- unique(g$layout$t[panels])
    nw <- length(panel_index_w)
    nh <- length(panel_index_h)
    if (panel.size){
        if (length(width)==1 & length(height)==1){
            g$widths[panel_index_w] <- rep(width, nw)
            g$heights[panel_index_h] <- rep(height, nh)
            if (!is.null(file)) {
                ggplot2::ggsave(file, g, width = grid::convertWidth(sum(g$widths) + 2 * margin, unitTo = "in", valueOnly = TRUE), height = grid::convertHeight(sum(g$heights) + 2 * margin, unitTo = "in", valueOnly = TRUE), useDingbats = useDingbats, ...)
                if (!is.null(bitmap)) {
                    ggplot2::ggsave(paste0(tools::file_path_sans_ext(file), ".", bitmap), g, width = grid::convertWidth(sum(g$widths) + 2 * margin, unitTo = "in", valueOnly = TRUE), height = grid::convertHeight(sum(g$heights) + 2 * margin, unitTo = "in", valueOnly = TRUE),  dpi = 600, ...)
                }
            }
        }
        else{
            g$widths[panel_index_w] <- width
            g$heights[panel_index_h] <- height
            if (!is.null(file)) {
                ggplot2::ggsave(file, g, width = grid::convertWidth(sum(g$widths) + 2 * margin, unitTo = "in", valueOnly = TRUE), height = grid::convertHeight(sum(g$heights) + 2 * margin, unitTo = "in", valueOnly = TRUE), useDingbats = useDingbats, ...)
                if (!is.null(bitmap)) {
                    ggplot2::ggsave(paste0(tools::file_path_sans_ext(file), ".", bitmap), g, width = grid::convertWidth(sum(g$widths) + 2 * margin, unitTo = "in", valueOnly = TRUE), height = grid::convertHeight(sum(g$heights) + 2 * margin, unitTo = "in", valueOnly = TRUE),  dpi = 600, ...)
                }
            }
        }
    }
    else{
        sum_panel_width = convertWidth(width - sum(g$widths[-panel_index_w]) - 2 * margin, unitTo = "in", valueOnly = TRUE)
        sum_panel_height = convertWidth(height - sum(g$heights[-panel_index_h]) - 2 * margin, unitTo = "in", valueOnly = TRUE)
        panel_width_r <- as.numeric(g$widths[panel_index_w])
        panel_height_r <- as.numeric(g$heights[panel_index_h])
        g$widths[panel_index_w] <- unit(panel_width_r/sum(panel_width_r)*sum_panel_width, units = "in")
        g$heights[panel_index_h] <- unit(panel_height_r/sum(panel_height_r)*sum_panel_height, units = "in")
        if (!is.null(file)) {
            ggplot2::ggsave(file, g, width = width, height = height, useDingbats = useDingbats, ...)
            if (!is.null(bitmap)) {
                ggplot2::ggsave(paste0(tools::file_path_sans_ext(file), ".", bitmap), g, width = grid::convertWidth(sum(g$widths) + 2 * margin, unitTo = "in", valueOnly = TRUE), height = grid::convertHeight(sum(g$heights) + 2 * margin, unitTo = "in", valueOnly = TRUE),  dpi = 600, ...)
            }
            print(g$widths[panel_index_w])
            print(g$heights[panel_index_h])
        }
    }
}

```

## Summarizing songbird resulst
### Examing songbird model fit
```{r}
dat_path = '../data/diff-analysis-new'
dat_files = list.files(dat_path, pattern = "grid-search-all-allowed-models", full.names = T)
dat_models = lapply(dat_files, function(x){read_tsv(x) %>% select(-X1) %>% filter(best=="Yes")}) %>% data.table::rbindlist(fill = T)
```
When performing songbird parameter summary, following parameters were tried:
```{r}
songbird_pp = read_csv("../data/diff-analysis-new/TP-w-training-grid-search-parameters-set.csv") %>%
    mutate(across(everything(), ~trimws(.x))) %>%
    separate(body_site_days, into = c("body_site", "days"), sep = "-(?=\\d)") %>%
    mutate(days = as.numeric(days))
songbird_pp
```

```{r, eval=FALSE}
songbird_model_fits <- read.table(file = "../data/diff-analysis-new/TP-w-training-grid-search-all-allowed-models.tsv", header = T, sep = "\t")[, -1]

songbird_best_models <- songbird_model_fits %>% filter(best=="Yes") %>%  # select best model under different formula
    filter(grepl("country", formula)) # since all the formula with country as covariate performed better
songbird_best_models_print <- songbird_best_models %>% 
    mutate(model_CV = round(CV, 1),
           null_CV = round(baseline_CV, 1),
           q_squared = round(q_squared, 3)) %>%
    select(body_site, days, min_features:differential_prior,
           model_CV, null_CV, q_squared) %>%
    arrange(body_site, days) %>%
    full_join(., songbird_pp, by = c("body_site", "days")) %>% 
    write.table(file = "../results/Extended_Data_Table_Songbird_model_fit_statistics.tsv", sep = "\t", quote = F, row.names = F)
```
```{r}
songbird_rsl <- read.csv("../data/diff-analysis-new/songbird-summary-output/TP-w-training-best-model-processed.tsv", sep = "\t", fill = F) %>% select(-1, -2, -starts_with("country")) %>% filter(grepl("country", model.para))

songbird_wk <- songbird_rsl %>% 
    select(body_site_days, featureid,
           X.T.CS., X.T.CSseed.,
           starts_with("P."), Taxon, 
           starts_with("centered"),
           feature.frequency, seeding.effectiveness) %>%
    rename(P.VD = P.Vaginal., P.CSR = P.CS.seeded., P.CS = P.CS.,
           Diff.CS = X.T.CS., Diff.CSR = X.T.CSseed.) %>%
    separate(body_site_days, into = c(NA, "body_site", "days"), sep = "-") %>% 
    mutate(days = as.numeric(days)) %>%
    group_by(body_site, days) %>% 
    mutate(seeding.effectiveness.scale = pnorm(as.numeric(scale(seeding.effectiveness, center = mean(seeding.effectiveness), scale = T)))) %>%
    ungroup() %>%
    arrange(body_site, days, desc(seeding.effectiveness.scale)) %>%
    mutate(featureid = factor(featureid, levels = unique(featureid)), 
           Taxon = gsub(" ", "", Taxon),
           Taxon = gsub("__", "_", Taxon)) %>%
    separate(Taxon, into = c("k", "p", "c", "o", "f", "g", "s"), sep = ";",
             remove = F,
             fill = "right") %>%
    mutate(across(k:s, ~ifelse(is.na(.x), "-", .x)))

# check the distribution of seeding-effectiveness score
ggplot(songbird_wk, aes(x = seeding.effectiveness)) +
    geom_histogram(aes(color = as.factor(days), fill = as.factor(days)), alpha = 0.3, position = "identity") +
    facet_grid(body_site ~ .)

songbird_wk %>% group_by(body_site, days) %>% summarise(stats = Hmisc::smean.sd(seeding.effectiveness) %>% paste(collapse = "--"))


songbird_wk_0.9 <- songbird_wk %>% 
    filter(seeding.effectiveness.scale>=0.9, feature.frequency>=0.1) %>%
    mutate(across(.cols = c(P.CS:P.VD, feature.frequency:seeding.effectiveness.scale), ~round(., 3)))
songbird_wk_0.9 %>% pivot_wider(id_cols = c(body_site, days, Taxon, k:s), names_from = NULL, values_from = c(Diff.CS, Diff.CSR, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS), names_repair = "minimal") %>% arrange(body_site, days, Taxon)
songbird_wk_0.8 <- songbird_wk %>% 
    filter(seeding.effectiveness.scale>=0.8, feature.frequency>=0.1) %>%
    mutate(across(.cols = c(P.CS:P.VD, feature.frequency:seeding.effectiveness.scale), ~round(., 3)))

songbird_wk_0.8 %>% group_by(body_site, days) %>% summarize(N = n())
```
```{r}
phylo_trans = readRDS("phylo_transmission_analysis.Rdata")
mf_tmp <- sample_data(phylo_trans) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")
## Maternal ASV paranatal
mf_mm_day0 <- mf_tmp %>% filter((mom_baby=="Mom" & as.numeric(date_sampling_category_days_continuous)<=2)|body_site_corrected=="Gauze")
mf_mm_day0$body_site_corrected[mf_mm_day0$body_site_corrected=="Gauze"] = "Vagina"
mf_mm_day0$birth_mode_ms[mf_mm_day0$birth_mode_ms=="CSself"] = "CSseed"
mf_mm_day0_vagina <- mf_mm_day0 %>% filter(body_site_corrected=="Vagina") %>% split(., list(.$birth_mode_ms))
otu_mm_day0_vagina <- parallel::mclapply(mf_mm_day0_vagina, function(x){prune_samples(x$sample_name, phylo_trans) %>% 
        otu_table %>% as.matrix() %>% as.data.frame() %>%
        filter(rowSums(.>0)>0.1*ncol(.)) %>%
        row.names()}, mc.cores = np) %>%
    do.call("c", .) %>%
    unique() # only include otu existed in more than 10% of samples

songbird_wk2 <- songbird_wk %>%
    filter(feature.frequency>=0.1, p!="p_", c!="c_", o!="o_", f!="f_", p!="-", c!="-", o!="-", f!="-") %>%
    mutate(VaginaASV = featureid %in% otu_mm_day0_vagina)
```
### Ternary plot
```{r}
plot_ternary = function(bb, dd, color_fun){
    TernaryPlot(point = "up",  alab = "P(Cesarean-seeded) <---", 
                blab = "P(Vaginal) --->", clab = "P(Cesarean) <---",
                lab.col = c( "#4DAF4A", "#377EB8", "#E41A1C"),
                lab.cex = 0.75,
                lab.offset = 0.15,
                
                grid.lines = 5,
                grid.minor.lines = 1,
                grid.col = c("#4DAF4A", "#377EB8", "#E41A1C"),
                grid.lty = "dotted",
                grid.lwd = 0.4,
                grid.minor.lty = "dotted",
                grid.minor.lwd = 0.2,
                grid.minor.col = c("#4DAF4A", "#377EB8", "#E41A1C"),
                
                padding = 0.12,
                
                main = paste0("Day ", dd),
                cex.main = 1,
                
                axis.col = "black",
                axis.labels=seq(0, 1, by = 0.2),
                axis.cex = 0.75,
                axis.lwd = 0.3,
                ticks.lwd = 0.3,
                
                clockwise = F)
    dat_ternary = songbird_wk %>% filter(body_site==bb, days==dd) %>% 
        select(P.CSR, P.VD, P.CS, seeding.effectiveness.scale)
    dat_ternary$col = color_fun(dat_ternary$seeding.effectiveness.scale)
    
    AddToTernary(points, dat_ternary[, 1:3], pch = 21, cex = 0.3, col = dat_ternary$col, bg = dat_ternary$col)
}


for (bb in c("Feces", "Forearm", "Mouth")){
    pdf(file = paste0(fig_path, "songbird_ternary_plot_", bb, ".pdf"), width = 6, height = 4, useDingbats = F, pointsize = 12)
    par(mfrow = c(1, 3), mar = rep(0.1, 4))
    for (dd in c(2, 30, 180)){
        color_fun = circlize::colorRamp2(seq(0, 1, 0.1), colors = sequential_hcl(11, palette = "Inferno"))
        plot_ternary(bb, dd, color_fun)
    }

    dev.off()
    next
    # create the legend
    pdf(file = paste0(fig_path, "songbird_ternary_plot_", bb, "_legend.pdf"), width = 3, height = 1, pointsize = 8, useDingbats = F)
    par(mai = c(0.3, 0.1, 0.3, 0.1))
    image(x = seq(0,1,len=100), 
          y = 1,
          z = matrix(1:100,ncol=1),
          main = "Probability of coexistance in exposed babies",
          cex.main = 1, 
          col = color_fun(seq(0,1,len=100)),
          axes = FALSE, xlab = "", ylab = "")
    axis(1, at = seq(0.1, 0.9, 0.2), cex.axis = 1)
    dev.off()
}

# create the main plot

```
### Plots
```{r}
load("diff_analysis_all_phylo.Rdata")

```
```{r}
target_taxa <- songbird_wk2 %>% 
    filter(body_site=="Feces", days==2, grepl("Streptococcus", Taxon)) %>%
    mutate(x = paste(p, c, o, f, g, sep = ";"))
ft_target <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
    transform_sample_counts(., function(x){x / sum(x)}) %>%
    otu_table() %>% as.matrix() %>% as.data.frame() %>%
    rownames_to_column(var = "ASV") %>%
    filter(ASV %in% target_taxa$featureid) %>% 
    pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
    filter(rel_a>0) %>%
    merge(., target_taxa, by.x = "ASV", by.y = "featureid") %>%
    merge(., sample_data(all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]]) %>% as.matrix %>% as.data.frame, by.x = "sample_name", by.y = 0)

ggplot(ft_target, aes(ASV, rel_a, color = birth_mode_ms)) +
    geom_boxplot() +
    stat_summary(geom = "point", fun = mean, position = position_dodge(width = 0.8)) +
    geom_text(aes(y = max(rel_a), label = Diff.CS)) +
    scale_x_discrete(breaks = ft_target$ASV, labels = ft_target$Taxon) +
    scale_y_continuous(trans = "log10") +
    coord_flip()
```

#### All genera plots against P.VD
```{r}
for (bb in c("Feces", "Forearm", "Mouth")){
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";"))
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        x.order = dat %>% group_by(x) %>% summarise(MM = median(P.VD)) %>% arrange(MM)
        
        p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = P.VD)) +
            #annotate("rect", ymin = 0, ymax = 0.25, xmin = -Inf, xmax = Inf, 
            #         fill = col_birthmode["CS"]#E41A1C", alpha = 0.1) +
            #annotate("rect", ymin = 0.75, ymax = 1, xmin = -Inf, xmax = Inf, 
            #         fill = "#377EB8", alpha = 0.1) +
            #geom_hline(yintercept = 0.5, color = "grey") +
            geom_point(aes(fill = seeding.effectiveness.scale), 
                       shape = 21, color = "black", size = 1.5) +
            scale_fill_continuous_divergingx(palette = 'Tropic', mid = 0.5, n_interp = 11) +
            scale_y_continuous(sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Relative probality in vaginal birth", 
                 fill = "Seeding Efficacy", title = paste(bb, "Day", dd),
                 subtitle = "All genera")
        
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10",
                               sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
    }
}
```

#### All genera plots against P.CS
```{r}
for (bb in c("Feces", "Forearm", "Mouth")){
    # bb = "Feces"
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";"))
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        x.order = dat %>% group_by(x) %>% summarise(MM = median(seeding.effectiveness.scale)) %>% arrange(MM)
        
        p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = P.CS)) +
            annotate("rect", ymin = 0, ymax = 0.25, xmin = -Inf, xmax = Inf, fill = col_birthmode["Vag"], alpha = 0.1) +
            annotate("rect", ymin = 0.75, ymax = 1, xmin = -Inf, xmax = Inf, fill = col_birthmode["CS"], alpha = 0.1) +
            geom_point(aes(fill = seeding.effectiveness.scale, shape = VaginaASV), color = "black", size = 1.5) +
            scale_fill_continuous_divergingx(palette = 'Tropic', mid = 0.5, n_interp = 11) +
            scale_y_continuous(sec.axis = dup_axis()) +
            scale_shape_manual(values = c(21, 24)) +
            coord_flip() +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Relative probality in cesarean birth", 
                 fill = "Seeding Efficacy", title = paste(bb, "Day", dd),
                 subtitle = "All genera")
        p
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10",
                               sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
        set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_p.cs_", bb, "_all-g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/130, "in"), useDingbats = F )
    }
}
```

#### Top `pct` ASV in genus plots against CS
```{r}
pct = 0.3
for (bb in c("Feces", "Forearm", "Mouth")){
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";"))
        x.order = dat %>% group_by(x) %>% 
            summarise(MM = max(seeding.effectiveness.scale), 
                      MM2 = median(seeding.effectiveness.scale)) %>% 
            arrange(desc(MM))
        x.order2 = head(x.order, n = round(nrow(x.order)*pct)) %>%
            arrange(MM2)
        dat <- dat %>% filter(x %in% x.order2$x)
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        p <- dat %>% mutate(x = factor(x, levels = unique(x.order2$x))) %>%
            ggplot(aes(x = x, y = P.CS)) +
            annotate("rect", ymin = 0, ymax = 0.25, xmin = -Inf, xmax = Inf, 
                     fill = col_birthmode["Vag"], alpha = 0.1) +
            annotate("rect", ymin = 0.75, ymax = 1, xmin = -Inf, xmax = Inf, 
                     fill = col_birthmode["CS"], alpha = 0.1) +
            geom_point(aes(fill = seeding.effectiveness.scale), 
                       shape = 21, color = "black", size = 1.5) +
            scale_fill_continuous_divergingx(palette = 'Tropic', mid = 0.5, n_interp = 11) +
            scale_y_continuous(sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Relative probality in cesarean birth", 
                 fill = "Seeding Efficacy", title = paste(bb, "Day", dd),
                 subtitle = paste("Top", pct, "genera"))
        p
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10",
                               sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
        #set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_p.cs_", bb, "_top", pct, "-g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/130, "in"), useDingbats = F )
    }
}
```
#### Top `pct` (in term of seeding effectiveness) ASV plots against seeding effectiveness
```{r}
pct = 0.2
for (bb in c("Feces", "Forearm", "Mouth")){
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
            arrange(desc(seeding.effectiveness.scale)) %>%
            head(n = nrow(.)*pct)
            
        x.order = dat %>% group_by(x) %>% 
            summarise(MM = median(seeding.effectiveness.scale)) %>% 
            arrange(MM)
        
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = seeding.effectiveness.scale)) +
            geom_point(aes(fill = P.CS), 
                       shape = 21, color = "black", size = 1.5) +
            scale_fill_continuous_divergingx(palette = 'RdYlBu', mid = 0.5, n_interp = 11, rev = T) +
            scale_y_continuous(n.breaks = 6) +
            coord_flip() +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Seeding efficacy", 
                 fill = "P.CS", title = paste(bb, "Day", dd),
                 subtitle = paste("Top", pct, "genera"))
        p
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10") +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
        set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_p.cs_", bb, "_top", pct, "-g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(10/.pt*nrow(dat), "mm"), useDingbats = F )
    }
}
```
#### Top `n_top` ASV plots against seeding effectiveness
```{r}
n_top = 20
#pct = 0.2
for (bb in c("Feces", "Forearm", "Mouth")){
    #dd=2
    dat <- songbird_wk2 %>% filter(body_site==bb) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
        group_by(days) %>%
        slice_max(seeding.effectiveness.scale, n = n_top)
    x.order = dat %>% group_by(x) %>% 
        summarise(MM = median(seeding.effectiveness.scale)) %>%
        arrange(MM)
    
    p <- dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
        ggplot(aes(x = x, y = seeding.effectiveness.scale)) +
        geom_point(aes(fill = P.CS), 
                   shape = 21, color = "black", size = 1.5) +
        scale_fill_continuous_divergingx(palette = 'RdYlBu', mid = 0.5, n_interp = 11, rev = T) +
        scale_y_continuous(n.breaks = 4) +
        coord_flip() +
        facet_grid(.~days) +
        theme_bw(base_size = 10) +
        labs(x = "", y = "Seeding efficacy", 
             fill = "P.CS", title = bb,
             subtitle = paste("Top", n_top, "ASV"))
    print(p)
    set_panel_size(p, file = paste0(fig_path, "songbird_p.cs_", bb, "_top", n_top, "-g.pdf"), width = unit(2, "in"), height = unit(10/.pt*length(unique(dat$x)), "mm"), useDingbats = F )
}
```

#### ASV above `pct` seeding effectiveness
```{r}
pct = 0.8
for (bb in c("Feces", "Forearm", "Mouth")){
    # bb="Feces"
    dat <- songbird_wk2 %>% filter(body_site==bb) %>%
        mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
        group_by(days) %>%
        filter(seeding.effectiveness.scale>=pct) %>%
        ungroup()
    
    dat_mat = dat %>% 
        pivot_wider(id_cols = c(featureid, Taxon), names_from = days, values_from = P.CS) %>%
        arrange(Taxon) %>% select(-Taxon) %>%
        column_to_rownames(var = "featureid")
    color_fun = circlize::colorRamp2(seq(0.1, 1, 0.1), colors = divergingx_hcl(10, palette = "RdYlBu", rev = T))
    
    df_row = dat %>% distinct(featureid, Taxon, p, c, o, f, g, s, x)
    p = Heatmap(dat_mat,
                rect_gp = gpar(col = "grey", lwd = 1),
                name = "Relative probability in CS",
                heatmap_legend_param = list(at = seq(0.1, 0.9, 0.2),
                                            labels_gp = gpar(fontsize = 6), 
                                            title_gp = gpar(fontsize = 7, fontface = "bold")),
                cluster_columns = F,
                cluster_rows = F,
                
                row_labels = paste(df_row$f, df_row$g, df_row$s, sep = ";")[match(rownames(dat_mat), df_row$featureid)],
                row_names_gp = gpar(fontsize = 8),
                column_names_side = "top",
                column_names_rot = 0,
                column_names_gp = gpar(fontsize = 9, fontface = "bold"),
                column_names_centered = T,
                column_title = "Days after birth",
                column_title_gp = gpar(fontsize = 10, fontface = "bold"),
                height = unit(9, "pt")*dim(dat_mat)[1],
                width = unit(1.2, "in"),
                col = color_fun,
                na_col = "white")
    p = draw(p)
    dev.copy2pdf(file = paste0(fig_path, "ASV", pct,"-Heatmap-", bb, ".pdf"), width = ComplexHeatmap:::width(p)/25.4, height = ComplexHeatmap:::height(p)/25.4, useDingbats = F)
    dev.off()

}
```
#### All gneus plots songbird differential
```{r}
for (bb in c("Feces", "Forearm", "Mouth")){
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";"))
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        x.order = dat %>% group_by(x) %>% summarise(MM = mean(centered.diff.CS)) %>% arrange(desc(MM))
        
        p = dat %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            arrange(x) %>%
            ggplot(aes(x = x, y = centered.diff.CS)) +
                coord_flip() +
            stat_summary(geom = "bar", fun = mean, fill = "grey50") +
            stat_summary(geom = 'errorbar', fun.data =  'mean_se') +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Songbird differentials with vaginal as reference", 
                 title = paste(bb, "Day", dd))
        p
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10",
                               sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
        set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_all-g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/130, "in"), useDingbats = F )
    }
}
```

#### Top `pct` genus plots songbird differential
```{r}
pct = 0.2
for (bb in c("Feces", "Forearm", "Mouth")){
    for (dd in c(2, 30, 120, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>%
            mutate(x = paste(p, c, o, f, g, sep = ";"))
        x.order = dat %>% group_by(x) %>% summarise(MM = median(centered.diff.CS)) %>% arrange(desc(MM))
        x.order2 = head(x.order, n = round(nrow(x.order)*pct)) %>%
            rbind(., tail(x.order, n = round(nrow(x.order)*pct)))
        dat <- dat %>% filter(x %in% x.order2$x)
        dat_sum <- dat %>% group_by(x) %>% summarise(sum_seeding = mean(seeding.effectiveness.scale), sum_diff = mean(centered.diff.CS))
        
        dat_ft <- all_phylo$ASV[[paste0("Baby-", bb, "-", dd, ".0")]] %>% 
            transform_sample_counts(., function(x){x / sum(x)}) %>%
            otu_table() %>% as.matrix() %>% as.data.frame() %>%
            rownames_to_column(var = "ASV") %>%
            filter(ASV %in% dat$featureid) %>% 
            pivot_longer(-1, names_to = "sample_name", values_to = "rel_a") %>% 
            filter(rel_a>0) %>%
            merge(., dat %>% select(featureid, k:s, x), by.x = "ASV", by.y = 1)
        
        p = dat %>% mutate(x = factor(x, levels = unique(x.order2$x))) %>%
            arrange(x) %>%
            ggplot(aes(x = x, y = centered.diff.CS)) +
                coord_flip() +
            geom_bar(dat = dat_sum %>% mutate(x = factor(x, levels = unique(x.order2$x))), stat = "identity", aes(y = sum_diff, fill = sum_seeding)) +
            stat_summary(geom = 'errorbar', fun.data =  'mean_se') +
            scale_fill_continuous_sequential(palette = "Inferno", n_interp = 11, rev = F) +
            theme_bw(base_size = 10) +
            labs(x = "", y = "Songbird differentials with vaginal as reference", 
                 title = paste(bb, "Day", dd))
        p2 <- dat_ft %>% mutate(x = factor(x, levels = unique(x.order2$x))) %>%
            ggplot(aes(x = x, y = rel_a)) +
            geom_boxplot(outlier.size = 1) +
            scale_y_continuous(breaks = c(1e-4, 1e-3, 1e-2, 1e-1, 1), 
                               labels =c("0.01%", "0.1%", "1%", "10%", "100%"), 
                               trans = "log10",
                               sec.axis = dup_axis()) +
            coord_flip() +
            theme_bw(base_size = 10) + theme(axis.text.y = element_blank()) +
            labs(x = "", y = "Relative Abundance in log scale")
        
        p3 = p + p2
        print(p3)
        set_panel_size(g = patchworkGrob(p3), file = paste0(fig_path, "songbird_diff_", bb, "_top", pct, "-g_day", dd, ".pdf"), width = unit(c(4, 3), "in"), height = unit(4*2.5*nrow(dat)/130, "in"), useDingbats = F )
    }
}
```


```{r}
pct = 0.2
for (bb in c("Feces", "Forearm", "Mouth")){
    p_list = list()
    max_n = 0
    for (dd in c(2, 30, 180)){
        #dd=2
        dat <- songbird_wk2 %>% filter(body_site==bb, days ==dd) %>% mutate(x = paste(p, c, o, f, g, sep = ";"))
        x.order = dat %>% group_by(x) %>% summarise(MM = median(centered.diff.CS)) %>% ungroup() %>% arrange(desc(MM)) 
        x.order2 = head(x.order, n = round(nrow(x.order)*pct)) %>%
            rbind(., tail(x.order, n = round(nrow(x.order)*pct)))
        dat <- dat %>% filter(x %in% x.order2$x) %>% mutate(x = factor(x, levels = unique(x.order2$x))) %>% arrange(x) 
        dat_sum <- dat %>% group_by(p, c, o, f, g, x) %>% summarise(med_seeding = median(seeding.effectiveness.scale), med_diff = median(centered.diff.CS), mean_seeding = round(mean(seeding.effectiveness.scale), 3), max_seeding = max(seeding.effectiveness.scale), VaginaASV = any(VaginaASV)) %>% mutate(g_label = ifelse(g %in% c("-", "g_"), f, gsub("g_", "", g)))
        
        p_list[[as.character(dd)]] = ggplot(dat_sum, aes(x = x, y = med_diff)) +
            coord_flip() +
            geom_bar(stat = "identity", aes(fill = max_seeding), color = "grey", size = 0.1) +
            geom_text(aes(y = ifelse(med_diff>0, -0.1, 0.1), label = g_label, hjust = ifelse(med_diff>0, 1, 0), color = VaginaASV), size = 6/.pt, show.legend = F) +
            scale_color_manual(values = c("black", "blue")) +
            scale_fill_continuous_sequential(palette = "Inferno", n_interp = 11, rev = F, begin = 0, end = 1, breaks = seq(0.1, 0.9, 0.2), limits = c(0, 1)) +
            theme_bw(base_size = 8) + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = margin(0, 0, 0, 0), panel.grid.major.y = element_blank()) +
            labs(x = "", y = expression(Songbird~differentials~":"~log~"("~frac(Cesarean, Vaginal)~")"~ + K), fill = "Probability of coexistance in exposed babies", title = paste(bb, "Day", dd))
        max_n = max(nrow(dat_sum), max_n)
    }
    p = wrap_plots(p_list) + plot_layout(guides = "collect")
    set_panel_size(g = patchworkGrob(p), file = paste0(fig_path, "songbird_diff_", bb, "_top", pct, "-g.pdf"), width = unit(2, "in"), height = unit(min(0.1*max_n, 4),"in"), useDingbats = F)
    
}
```
### Tables
```{r}
songbird_wk2 %>% mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
    group_by(body_site, days) %>%
    slice_max(seeding.effectiveness.scale, n = 20) %>%
    arrange(body_site, days, Taxon, desc(seeding.effectiveness.scale)) %>%
    select(body_site, days, p:s, featureid, VaginaASV, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS) %>%
    mutate(across(seeding.effectiveness.scale:P.CS, ~round(.x, 3))) %>%
    write.table(file = "../data/diff-analysis-new/songbird-summary-output/songbird_top20_seedingeffectiveness_asv.tsv", sep = "\t", quote = F, row.names = F)

songbird_wk2 %>% mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
    group_by(body_site, days) %>%
    slice_max(seeding.effectiveness.scale, prop = 0.2) %>%
    arrange(body_site, days, Taxon, desc(seeding.effectiveness.scale)) %>%
    select(body_site, days, p:s, featureid, VaginaASV, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS) %>%
    mutate(across(seeding.effectiveness.scale:P.CS, ~round(.x, 3))) %>%
    write.table(file = "../data/diff-analysis-new/songbird-summary-output/songbird_top0.2_seedingeffectiveness_asv.tsv", sep = "\t", quote = F, row.names = F)

songbird_wk2 %>% mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
    group_by(body_site, days) %>%
    filter(seeding.effectiveness.scale>=0.8) %>%
    arrange(body_site, days, Taxon, desc(seeding.effectiveness.scale)) %>%
    select(body_site, days, p:s, featureid, VaginaASV, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS) %>%
    mutate(across(seeding.effectiveness.scale:P.CS, ~round(.x, 3))) %>%
    write.table(file = "../data/diff-analysis-new/songbird-summary-output/songbird_seedingeffectiveness0.8_asv.tsv", sep = "\t", quote = F, row.names = F)

songbird_wk2 %>% mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
    group_by(body_site, days) %>%
    filter(seeding.effectiveness.scale>=0.8) %>%
    arrange(body_site, days, Taxon, desc(seeding.effectiveness.scale)) %>%
    select(body_site, days, p:s, VaginaASV, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS) %>%
    mutate(across(seeding.effectiveness.scale:P.CS, ~round(.x, 3))) %>%
    group_by(body_site, days, VaginaASV) %>% summarise(N = n()) %>% mutate(Pct = N/sum(N)) %>% filter(VaginaASV)

songbird_wk2 %>% mutate(x = paste(p, c, o, f, g, sep = ";")) %>%
    split(., f = list(.$body_site, .$days)) %>%
    lapply(., function(x){rbind(slice_max(x, centered.diff.CS, prop = 0.2), slice_min(x, centered.diff.CS, prop = 0.2))}) %>%
    data.table::rbindlist(.) %>%
    arrange(body_site, days, Taxon, desc(centered.diff.CS)) %>%
    select(body_site, days, p:s, featureid, VaginaASV, centered.diff.CS, seeding.effectiveness.scale, feature.frequency, P.VD, P.CSR, P.CS) %>%
    mutate(across(centered.diff.CS:P.CS, ~round(.x, 3))) %>%
    write.table(file = "../data/diff-analysis-new/songbird-summary-output/songbird_topbottom0.2_differential_asv.tsv", sep = "\t", quote = F, row.names = F)
```
## Summarizing ANCOM results
```{r}
dat_path = list.files(path = "../data/diff-analysis-new/ancom_all_results/ancom_w_country",  pattern = "*rds", full.names = T, include.dirs = F)

dat_nms <- (dat_path %>% str_split(., "/|\\.", simplify = T))[, 8]
dat_files <- lapply(dat_path, function(x){readRDS(x)})
names(dat_files) <- dat_nms

dat_flt <- lapply(dat_files, function(x){lapply(x, function(y){y$W.taxa %>% filter(detected_0.6==T)}) %>%
        do.call("rbind", .) %>%
        rownames_to_column(var = "body_site_days")}) %>%
    do.call("rbind", .) %>%
    rownames_to_column(var = "level") %>%
    separate(level, into = c(NA, NA, "level", NA), sep = "_|\\.") %>%
    separate(body_site_days, into = c(NA, "body_sites", "days", NA, NA), sep = "-|\\.") %>%
    mutate(days = as.numeric(days))
dat_flt$Taxa_id[dat_flt$level!="ASV"] = NA

write.table(dat_flt, file = "../data/diff-analysis-new/ancom_all_results/ancom_w_country_all_rsl.txt", sep = "\t", quote = F, row.names = F)
```

```{r}
dat_flt %>% filter(level=="Genus") %>% arrange(body_sites, days) %>% View

```

## Summarizing pairwise ANCOM results
```{r}
dat_path = list.files(path = "../data/diff-analysis-new/ancom_all_results/ancom_w_country_pairwise/",  pattern = "*rds", full.names = T, include.dirs = F)
dat_nms <- ((dat_path %>% str_split(., "/|\\.", simplify = T))[, 9] %>% str_split(., "_", simplify = T))[, 4]

dat_files <- lapply(dat_path, function(x){readRDS(x)})
names(dat_files) <- dat_nms

summarize_ancom_output <- function(ancom_out, main_var){
    ancom_out = ancom_out
    ancom_out_tst = ancom_out$W.taxa %>% as.data.frame()
    ancom_out_mf = ancom_out$mf %>% select(Sample.ID, all_of(main_var))
    ancom_out_ft = ancom_out$ft %>% merge(., ancom_out_mf, by = 1) %>% select(Sample.ID, all_of(main_var), all_of(ancom_out_tst$otu.names)) %>% pivot_longer(-c(1, 2), names_to = "otu.names", values_to = "count") %>% group_by(across(main_var), Sample.ID) %>% mutate(rel_a = count/sum(count)) %>% ungroup()
    ancom_out_feature_means <- ancom_out_ft %>% 
        group_by(otu.names, across(main_var)) %>%
        summarise(mean_rel_a = mean(rel_a), med_rel_a = median(rel_a)) %>% 
        ungroup() %>% 
        pivot_wider(id_cols = otu.names, 
                    names_from = main_var, 
                    values_from = c(mean_rel_a, med_rel_a),
                    names_sep = ".")
    ancom_out_f = merge(ancom_out_tst, ancom_out_feature_means, by = "otu.names")
    return(ancom_out_f)
}

dat_sum = list()
for (i in seq_along(dat_files)){
    nm = names(dat_files)[i]
    dat_sum_ = list()
    for (j in seq_along(dat_files[[i]])){
        grp = names(dat_files[[i]])[j]
        dat_sum_[[grp]] = lapply(dat_files[[i]][[j]], function(x){summarize_ancom_output(x, "birth_mode_ms")}) %>% data.table::rbindlist(., idcol = "Comp", fill = T)
    }
    dat_sum[[nm]] = data.table::rbindlist(dat_sum_, idcol = "body_site_days", use.names = T)
}

dat_sum_asv_flt = dat_sum$ASV %>% filter(detected_0.6) %>% separate(body_site_days, into = c(NA, "Sampling Site", "Days"), sep = "-") %>% mutate(Flag_mean = case_when(Comp=="CS-Vag" ~ mean_rel_a.CS>mean_rel_a.Vag, Comp=="CS-CSseed" ~ mean_rel_a.CS>mean_rel_a.CSseed, Comp=="CSseed-Vag" ~ mean_rel_a.CSseed>mean_rel_a.Vag), Flag_med = case_when(Comp=="CS-Vag" ~ med_rel_a.CS>med_rel_a.Vag, Comp=="CS-CSseed" ~ med_rel_a.CS>med_rel_a.CSseed, Comp=="CSseed-Vag" ~ med_rel_a.CSseed>med_rel_a.Vag), Comp = factor(Comp, levels = c("CS-Vag", "CSseed-Vag", "CS-CSseed")), Days = as.numeric(Days)) %>% ungroup() %>% arrange(`Sampling Site`, Days, Comp, Phylum, Class, Order, Family, Genus, Species)

write.table(dat_sum_asv_flt, file = "../data/diff-analysis-new/ancom_all_results/ancom_w_country_pairwise_ASV_rsl.txt", sep = "\t", quote = F, row.names = F)
```
