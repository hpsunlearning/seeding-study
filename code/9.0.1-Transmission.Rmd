---
title: "Source Tracking Analysis"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(conflicted)
library(tidyverse)
library(extrafont)
# library(biomformat)
# library(ape)
# library(qiime2R)
library(phyloseq)
library(ComplexHeatmap)
library(patchwork)
library(ggrepel)
sessionInfo()
conflict_prefer("filter", "dplyr")

np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)

fig_path = "tmp_figs/"
```


## Pre-processing (no need to rerun)
### baby and maternal samples (rarefied tables)
```{r, eval=FALSE}
# all body sites to use for now
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

# baby qza address
bb_qza_dirs <- paste0("../data/split-data/Baby-", ss[1:3])
# mom qza address
mm_qza_dirs <- paste0("../data/split-data/Mom-", ss)

# import qza tables
bb_qza <- parallel::mclapply(bb_qza_dirs, FUN = function(x){read_qza(paste0(x, "/rarefy-table.qza"))}, mc.cores = np)
names(bb_qza) <- paste0("Baby-", ss[1:3])
#lapply(bb_qza, function(x){x$data %>% dim})

mm_qza <- parallel::mclapply(mm_qza_dirs, FUN = function(x){read_qza(paste0(x, "/rarefy-table.qza"))}, mc.cores = np )
names(mm_qza) <- paste0("Mom-", ss)

#lapply(mm_qza, function(x){x$data %>% dim})


# import metadata
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)
## extract metadata for
mf_ss <- mf %>% filter(sample_name %in% (sapply(c(bb_qza, mm_qza), FUN = function(x)colnames(x$data)) %>% unlist()))
mf_ss$body_site_corrected[mf_ss$body_site_corrected=="Right_Forearm"] = "Forearm"
```

### Gauze samples (this needs to be udpated once uploading gauze sequences into qiita)
```{r, eval=FALSE}
ft_qza_all <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/SA-P1-P3_deblur_no-mitochondria-no-chloroplast_table.qza")
mf_gauze <- read.table("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/0-Doc/Mapping_baby_seeding_gauze.txt", header = T, sep = "\t")
ft_tbl_gauze <- ft_qza_all$data[, mf_gauze$sample_name] %>% as.data.frame %>% filter(rowSums(.)>0)
```

### Create phyloseq object
```{r, eval=FALSE}
otu_ss <- parallel::mclapply(c(bb_qza, mm_qza), function(x){otu_table(x$data %>% as.data.frame %>% select(any_of(mf_ss$sample_name)) %>% filter(rowSums(.)>0), taxa_are_rows = T)}, mc.cores = np)

## import the otu table into phyloseq
otu_ss_phylo <- do.call("merge_phyloseq", otu_ss)

taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
taxa_tbl <- taxa_qza$data %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"

taxa_all <- taxa_tbl %>% filter(Feature.ID %in% rownames(otu_table(otu_ss_phylo))) %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

ss_phylo <- merge_phyloseq(otu_ss_phylo, taxa_all, sample_data(mf_ss %>% column_to_rownames(var = "sample_name")))


taxa_qza_gauze <- read_qza("~/Dropbox/41-JCHWANG-NYU/Projects/05-BabyProject2017RobKnight/GauzeSeq/3-deblur/taxonomy_gg13_8.qza")
taxa_gauze_tbl <- taxa_qza_gauze$data %>% filter(Feature.ID %in% rownames(ft_tbl_gauze)) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = T)
taxa_gauze_tbl$Domain[is.na(taxa_gauze_tbl$Domain)] <- "k_"
taxa_gauze_tbl$Phylum[is.na(taxa_gauze_tbl$Phylum)] <- "p_"
taxa_gauze_tbl$Class[is.na(taxa_gauze_tbl$Class)] <- "c_"
taxa_gauze_tbl$Order[is.na(taxa_gauze_tbl$Order)] <- "o_"
taxa_gauze_tbl$Family[is.na(taxa_gauze_tbl$Family)] <- "f_"
taxa_gauze_tbl$Genus[is.na(taxa_gauze_tbl$Genus)] <- "g_"
taxa_gauze_tbl$Species[is.na(taxa_gauze_tbl$Species)] <- "s_"
taxa_gauze_tbl <- taxa_gauze_tbl %>% select(Feature.ID, Domain:Species) %>% column_to_rownames(var = "Feature.ID") %>% as.matrix() %>% tax_table()

phylo_gauze <- merge_phyloseq(otu_table(ft_tbl_gauze, taxa_are_rows = T), taxa_gauze_tbl, sample_data(mf_gauze %>% column_to_rownames(var = "sample_name")))
phylo_gauze_5k <- rarefy_even_depth(phylo_gauze, sample.size = 5000, rngseed = 20, replace = F, trimOTUs = T)

phylo_wk <- merge_phyloseq(ss_phylo, phylo_gauze_5k) %>% prune_taxa(taxa_sums(.)>0, .)
saveRDS(phylo_wk, file = "phylo_transmission_analysis.Rdata")
```
## Analysis
```{r}
ss <- c("Feces", "Mouth", "Forearm", "Vagina", "Right_Areola", "Nose")

phylo_wk = readRDS("phylo_transmission_analysis.Rdata")
mf_wk <- sample_data(phylo_wk) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "sample_name")
```
### Use mothers and babies as a whole
```{r}
## Maternal ASV paranatal
mf_mm_day0 <- mf_wk %>% filter((mom_baby=="Mom" & as.numeric(date_sampling_category_days_continuous)==0)|body_site_corrected=="Gauze")
mf_mm_day0_lst <- mf_mm_day0 %>% split(., list(.$body_site_corrected))
mf_mm_day0_lst$Vagina <- rbind(mf_mm_day0_lst$Vagina, mf_mm_day0_lst$Gauze)
mf_mm_day0_lst$Gauze <- NULL
otu_mm_day0_lst <- parallel::mclapply(mf_mm_day0_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np) # only include otu existed in more than 10% of samples

## Baby ASVs
mf_bb_lst <- mf_wk %>% filter(mom_baby=="Baby") %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
otu_baby_lst <- parallel::mclapply(mf_bb_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np)
```
```{r, eval = F}
mf_mm_day0_vagina <- mf_wk %>% filter(mom_baby=="Mom", as.numeric(date_sampling_category_days_continuous)<=1, body_site_corrected=="Vagina")

mf_mm_day0_vagina_rs <- mf_mm_day0_vagina %>% mutate(birth_mode_ms=ifelse(birth_mode_ms=="CSself", "CSseed", birth_mode_ms)) %>% group_by(birth_mode_ms) %>% sample_n(10)

phylo_tmp <- prune_samples(mf_mm_day0_vagina_rs$sample_name, phylo_wk)

p <- plot_bar(phylo_tmp,  fill = "Genus")
p_dat <- p$data %>% group_by(birth_mode_ms, Sample, Domain, Phylum, Class, Order, Family, Genus) %>% summarise(Abundance = sum(Abundance)) %>% filter(Abundance>0) 
p_dat_2 <- p_dat %>% mutate(Genus = ifelse(Abundance>=50, Genus, "LowAbundance"), birth_mode_ms=ifelse(birth_mode_ms=="CSself", "CSseed", birth_mode_ms)) %>% #>=1% of 5000
    group_by(Domain, Phylum, Class, Order, Family, Genus) %>% mutate(Taxa_index = cur_group_id(), Label = paste(cur_group_id(), Class, Order, Family, Genus, sep = ";"))

ggplot(p_dat_2 %>% filter(Genus != "LowAbundance"), aes(x = Sample, y = Abundance, fill = Label)) +
    geom_bar(stat = "identity") +
    geom_text(data = p_dat_2 %>% filter(Abundance>=500), aes(label = Taxa_index), vjust = 0.5) +
    facet_grid(.~birth_mode_ms, scales = "free_x") 
```

#### Plot individual samples and ASVs on heatmap
```{r}
get_heatmap <- function(birthmode, row_cluster=NULL){
    bm = birthmode # the string of birth mode, ["CS", "Vag", "CSseed"]
    mf_bb_tmp1 <- mf_bb_tmp %>% filter(sample_name %in% colnames(otu_bb_tmp[[paste(ss_b, bm, sep = ".")]])) %>% arrange(as.numeric(date_sampling_category_days_continuous))
    
    ## create the matrix for heatmap
    otu_mat1 <- otu_mm_tmp[otu_cc, ] %>% merge(., otu_bb_tmp[[paste(ss_b, bm, sep = ".")]][, mf_bb_tmp1$sample_name], by = 0, all.x = T) %>% column_to_rownames(var = "Row.names")
    ### convert to log scale
    otu_mat1 = log10(otu_mat1/5000)
    ### convert na or Inf to be -5, a value that is beyond the actual data range
    otu_mat1[otu_mat1==-Inf] = -5
    otu_mat1[is.na(otu_mat1)] = -5
    
    ## create the cluster for dendrogram of ASV based on baby samples only if it is Vag
    if (bm=="Vag"){
        row_cluster <- hclust(dist(otu_mat1[,  mf_bb_tmp1$sample_name]))
        row_cluster_flag = T
    } else {
        if (is.null(row_cluster)){stop("please provide row dendrogram or cluster")}
        row_cluster_flag = F
    }
    
    ## metadata for the heatmap
    meta_mat1 <- rbind(mf_mm_tmp, mf_bb_tmp1)
    ## data table for column annotation
    df_col <- meta_mat1 %>% ungroup %>% select(mom_baby, date_sampling_category_days_continuous) %>% 
        mutate(mom_baby = factor(mom_baby, levels = c("Mom", "Baby")),
               date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous),
               Days = case_when(date_sampling_category_days_continuous<=7 ~ "0-7",
                                date_sampling_category_days_continuous<=30 ~ "14-30",
                                date_sampling_category_days_continuous>=240 ~ ">=240",
                                T ~ as.character(date_sampling_category_days_continuous)),
               Days =  factor(Days, levels = c("0-7","14-30","60","90","120","150","180","210",">=240")),
               date_sampling_category_days_continuous = NULL)
    
    ## color scheme for the heatmap cells
    mat_col_fun = circlize::colorRamp2(c(-5, -4, -3.3, -2.6, -1.9, -1.2, -0.5), c("grey60","#253494", "#2c7fb8", "#41b6c4", "#7fcdbb", "#c7e9b4", "#ffffcc"))
    
    Days_col = c('#fff7f3','#fde0dd','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177','#49006a')
    names(Days_col) <- df_col$Days %>% unique
    
    col_ha1 = columnAnnotation(mom_baby = df_col$mom_baby, col = list(mom_baby=c("Mom" = '#fdcdac', "Baby" = '#b3e2cd')), show_annotation_name = F,
                               Days = anno_block(gp = gpar(fill = Days_col), labels = names(Days_col), labels_gp = gpar(col = "black", fontsize = 6)),
                               annotation_name_gp = gpar(fontsize = 7), 
                               annotation_legend_param = list(mom_baby = list(labels_gp = gpar(fontsize = 7), title_gp = gpar(fontsize = 7, fontface = "bold"))))
    p1 <- Heatmap(otu_mat1, 
                  
                  name = "Relative abundance",
                  heatmap_legend_param = list(at = c(-4, -3.3, -2.6, -1.9, -1.2, -0.5), labels = c("0.01%", "0.05%", "0.25%", "1.25%", "6.25%", "31.25%"),
                                              labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold")),
                  
                  column_title = bm,
                  
                  cluster_rows = row_cluster,
                  cluster_columns = F,
                  show_column_names = F,
                  show_row_names = F,
                  row_dend_reorder = row_cluster_flag,
                  
                  col = mat_col_fun,
                  
                  top_annotation = col_ha1,
                  
                  row_dend_width = unit(15, "mm"),
                  
                  column_split = df_col$Days,
                  column_gap = unit(rep(0, 8), "mm"),
                  cluster_column_slices = F,
                  
                  height = unit(7/.pt, "mm")*dim(otu_mat1)[1],
                  width = unit(0.7/.pt, "mm")*dim(otu_mat1)[2])
    return(p1)
}
for (ss_m in ss){
    #ss_m = ss[1]
    for (ss_b in ss[1:3]){
        #ss_b = ss[1]
        # select mother samples
        mf_mm_tmp <- mf_mm_day0 %>% filter(body_site_corrected==ss_m)
        otu_mm_tmp <- otu_mm_day0_lst[[ss_m]] 
        
        # select baby samples
        mf_bb_tmp <- mf_wk %>% filter(mom_baby=="Baby", body_site_corrected==ss_b)
        otu_bb_tmp <- otu_baby_lst[grepl(ss_b, names(otu_baby_lst))]
        
        otu_bb_all <- lapply(otu_bb_tmp, rownames) %>% do.call("c", .) %>% unique # all otu from babies, regardless birth mode
        
        otu_cc <- intersect(rownames(otu_mm_tmp), otu_bb_all) # common otu between maternal and baby samples
        
        p_vag <- get_heatmap("Vag")
        p_csr <- get_heatmap("CSseed", row_cluster = row_dend(p_vag))
        p_cs <- get_heatmap("CS", row_cluster = row_dend(p_vag))
        
        pdf(paste0(fig_path, "compare_asv_individual_m-", ss_m, "_b-", ss_b, ".pdf"), width = ((nrow(mf_bb_tmp)+3*nrow(mf_mm_tmp))*0.7/.pt+60)/25.4, height = length(otu_cc)*7/.pt*1.2/25.4, useDingbats = F)
        draw(p_vag + p_csr + p_cs, column_title = paste0("Mom.", ss_m, " vs Baby.", ss_b))
        dev.off()
        
    }
}

```

#### Plot average of baby samples by birth mode and timepoint and ASVs on heatmap
```{r}
mm_day0_asv_all <- lapply(otu_mm_day0_lst, rownames) %>% do.call("c", .) %>% unique
df_row0 <- data.frame(ASV = mm_day0_asv_all)
for (ss_m in ss){
    df_row0[[ss_m]] = df_row0$ASV %in% rownames(otu_mm_day0_lst[[ss_m]])
}
df_row0 <- merge(df_row0, tax_table(phylo_wk), by.x = "ASV", by.y = 0, all.x = T) %>% mutate(across(Domain:Species, ~gsub(pattern = "^[[:lower:]]_(.+)", replacement = "\\1", .x)), Index = paste0("ASV", seq(n()))) %>% unite("Taxa", Domain:Index, sep = ";")


get_heatmap2 <- function(birthmode, row_cluster=NULL){
    bm = birthmode # the string of birth mode, ["CS", "Vag", "CSseed"]
    
    ## create the matrix for heatmap
    otu_mat_bb_tmp <- otu_bb_tmp_avg[[paste(ss_b, bm, sep = ".")]] %>% mutate(date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous)) %>% pivot_wider(id_cols = ASV, names_from = date_sampling_category_days_continuous, values_from = Count) %>% column_to_rownames(var = "ASV")
    otu_mat1 <- otu_mm_tmp_avg[otu_cc, ,drop = F] %>% merge(., otu_mat_bb_tmp, by = 0, all.x = T) %>% column_to_rownames(var = "Row.names")
    ### convert to log scale
    otu_mat1 = log10(otu_mat1/5000)
    ### convert na or Inf to be -5, a value that is beyond the actual data range
    otu_mat1[otu_mat1==-Inf] = -5
    otu_mat1[is.na(otu_mat1)] = -5
    
    ## create the cluster for dendrogram of ASV based on baby samples only if it is Vag
    if (bm=="Vag"){
        row_cluster <- hclust(dist(otu_mat1[, -1]))
        row_cluster_flag = T
    } else {
        if (is.null(row_cluster)){stop("please provide row dendrogram or cluster")}
        row_cluster_flag = F
    }
    
    ## metadata for the heatmap
    
    ## data table for column annotation
    df_col <- data.frame(Col.lab = colnames(otu_mat1)) %>%
        mutate(mom_baby = factor(c("Mom", rep("Baby", ncol(otu_mat1)-1)), levels = c("Mom", "Baby")),
               Days = as.numeric(c(0, colnames(otu_mat1)[-1])),
               Days = case_when(Days<=7 ~ "0-7",
                                Days<=30 ~ "14-30",
                                Days>=240 ~ ">=240",
                                T ~ as.character(Days)),
               Days =  factor(Days, levels = c("0-7","14-30","60","90","120","150","180","210",">=240")))
    
    ## color scheme for the heatmap cells
    mat_col_fun = circlize::colorRamp2(c(-5, -4, -3.3, -2.6, -1.9, -1.2, -0.5), c("grey60","#253494", "#2c7fb8", "#41b6c4", "#7fcdbb", "#c7e9b4", "#ffffcc"))
    
    Days_col = c('#fff7f3','#fde0dd','#fcc5c0','#fa9fb5','#f768a1','#dd3497','#ae017e','#7a0177','#49006a')
    names(Days_col) <- df_col$Days %>% unique
    
    col_ha1 = columnAnnotation(mom_baby = df_col$mom_baby, col = list(mom_baby=c("Mom" = '#fdcdac', "Baby" = '#b3e2cd')), show_annotation_name = F,
                               Days = anno_block(gp = gpar(fill = Days_col), labels = names(Days_col), labels_gp = gpar(col = "black", fontsize = 6)),
                               annotation_name_gp = gpar(fontsize = 7), 
                               annotation_legend_param = list(mom_baby = list(labels_gp = gpar(fontsize = 7), title_gp = gpar(fontsize = 7, fontface = "bold"))))
    
    df_row <- df_row0 %>% filter(ASV %in% otu_cc) %>% select(-all_of(ss_m)) %>% mutate(across(-c(ASV, Taxa), ~ifelse(.x, "Y", "N")))
    df_row2 = df_row %>% select(-c(ASV, Taxa))
    df_row2_col = lapply(colnames(df_row2), function(x){c("Y" = "blue", "N" = "white")}) 
    names(df_row2_col) = colnames(df_row2)
    row_ha1 = rowAnnotation(df = df_row2, col = df_row2_col, gp = gpar(col = "black"), show_legend = F, 
                            annotation_name_side = "top", annotation_name_gp = gpar(fontsize = 7))
    
    p1 <- Heatmap(otu_mat1,
                  name = "Relative Abundance",
                  heatmap_legend_param = list(at = c(-4, -3.3, -2.6, -1.9, -1.2, -0.5), labels = c("0.01%", "0.05%", "0.25%", "1.25%", "6.25%", "31.25%"),
                                              labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold")),
                  
                  column_title = bm,
                  
                  cluster_rows = row_cluster,
                  cluster_columns = F,
                  show_column_names = F,
                  row_dend_reorder = row_cluster_flag,
                  
                  col = mat_col_fun,
                  rect_gp = gpar(col = "grey", lwd = 0.5),
                  
                  top_annotation = col_ha1,
                  left_annotation = if(bm=="Vag"){row_ha1}else{NULL},
                  
                  row_names_gp = gpar(fontsize = 7), 
                  row_labels = df_row$Taxa,
                  row_names_side = "right",
                  
                  row_dend_width = unit(15, "mm"),
                  
                  column_split = df_col$Days,
                  column_gap = unit(rep(0, 8), "mm"),
                  cluster_column_slices = F,
                  
                  
                  
                  height = unit(7/.pt, "mm")*dim(otu_mat1)[1],
                  width = unit(10/.pt, "mm")*dim(otu_mat1)[2])
    
    return(p1)
}
for (ss_m in ss){
    #ss_m = ss[1]
    for (ss_b in ss[1:3]){
        #ss_b = ss[1]
        # select mother samples
        otu_mm_tmp <- otu_mm_day0_lst[[ss_m]] 
        otu_mm_tmp_avg <- rowMeans(otu_mm_tmp) %>% data.frame(MomD0 = .)

        # select baby samples
        mf_bb_tmp <- mf_wk %>% filter(mom_baby=="Baby", body_site_corrected==ss_b)
        otu_bb_tmp <- otu_baby_lst[grepl(ss_b, names(otu_baby_lst))]
        otu_bb_tmp_avg <- parallel::mclapply(otu_bb_tmp, function(x){x %>% rownames_to_column(var = "ASV") %>% pivot_longer(names_to = "sample_name", values_to = "Count", -1) %>% merge(., mf_bb_tmp, by = "sample_name", all.x = T) %>% group_by(ASV, birth_mode_ms, date_sampling_category_days_continuous) %>% summarise(Count = mean(Count)) %>% ungroup()}, mc.cores = np)
        
        otu_bb_all <- lapply(otu_bb_tmp, rownames) %>% do.call("c", .) %>% unique # all otu from babies, regardless birth mode
        otu_cc <- intersect(rownames(otu_mm_tmp_avg), otu_bb_all) # common otu between maternal and baby samples
        
        p_vag <- get_heatmap2("Vag")
        p_csr <- get_heatmap2("CSseed", row_cluster = row_dend(p_vag))
        p_cs <- get_heatmap2("CS", row_cluster = row_dend(p_vag))
        
        
        pdf(paste0(fig_path, "compare_asv_avg_m-", ss_m, "_b-", ss_b, ".pdf"), width = (57*10/.pt)*2.5/25.4, height = length(otu_cc)*7/.pt*1.4/25.4, useDingbats = F)
        draw(p_vag + p_csr + p_cs, column_title = paste0("Mom.", ss_m, " vs Baby.", ss_b), merge_legend = TRUE, heatmap_legend_side = "bottom", 
    annotation_legend_side = "bottom")
        dev.off()
        
    }
}
```

<!-- ### Plot average of baby samples by birth mode and timepoint and species on heatmap -->

<!-- ```{r} -->
<!-- phylo_wk = readRDS("tmp_phylo_wk_transmission.Rdata") -->

<!-- ## Maternal ASV paranatal -->
<!-- mf_mm_day0 <- mf_wk %>% filter(mom_baby=="Mom", as.numeric(date_sampling_category_days_continuous)==0) -->
<!-- mf_mm_day0_lst <- mf_mm_day0 %>% split(., list(.$body_site_corrected)) -->

<!-- otu_mm_day0_lst <- parallel::mclapply(mf_mm_day0_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np) # only include otu existed in more than 10% of samples -->

<!-- ## Baby ASVs -->
<!-- mf_bb_lst <- mf_wk %>% filter(mom_baby=="Baby") %>% split(., list(.$body_site_corrected, .$birth_mode_ms)) -->
<!-- otu_baby_lst <- parallel::mclapply(mf_bb_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np) -->
<!-- ``` -->


#### Network

```{r}
ss <- c("Vagina", "Feces", "Mouth", "Forearm", "Right_Areola", "Nose")

asv_mm_day0_all <- lapply(seq_along(otu_mm_day0_lst), function(x){data.frame(ASV = rownames(otu_mm_day0_lst[[x]]), Bodysite = names(otu_mm_day0_lst)[[x]])}) %>% do.call("rbind",.)

asv_mm_day0_filt <- asv_mm_day0_all %>% mutate(Bodysite = factor(Bodysite, levels = ss)) %>% arrange(Bodysite, ASV) %>% group_by(ASV) %>%
    summarise(Grp = paste(Bodysite, collapse = "."), N_site = n())
```
##### Maternal vagina
```{r}
asv_mm_day0_filt_v <- asv_mm_day0_filt %>% filter(grepl("Vagina", Grp)) %>% 
    mutate(Grp2 = case_when(Grp=="Vagina" ~ "Vagina.Only",
                            N_site <=2 ~ Grp,
                            grepl("Vagina.Feces.", Grp) ~ "Vagina.Feces.Others",
                            grepl("Vagina.Forearm.", Grp) ~ "Vagina.Forearm.Others",
                            T ~ "Vagina.Others")) %>%
    mutate(Grp2 = factor(Grp2, levels = c("Vagina.Only", "Vagina.Feces", "Vagina.Feces.Others", "Vagina.Forearm", "Vagina.Forearm.Others", "Vagina.Others"))) %>%
    ungroup %>% arrange(Grp2, ASV)
nrow(asv_mm_day0_filt_v)
asv_mm_day0_filt_v$Grp2 %>% table(useNA = "ifany")

bb_col <- c("#F8766D","#00BA38","#619CFF")
    names(bb_col) <- c("Feces", "Forearm", "Mouth")
    
    mm_col <- c('purple','black','#F8766D', 'orange', '#00BA38', 'grey')
    names(mm_col) <- c("Vagina.Only", "Vagina.Feces", "Vagina.Feces.Others", "Vagina.Forearm", "Vagina.Forearm.Others", "Vagina.Others")
```
###### Plot baby source at day 30, 90, 240
```{r}
dds = c("Day_30", "Day_90", "Day_240")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

n_max <- asv_bb_tmp %>% separate(sample, into = paste0("V", seq(3)), sep = "\\.") %>% group_by(V2, V3) %>% summarise(N=n()) %>% pull(N) %>% max(c(., nrow(asv_mm_day0_filt_v)))
p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3], bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1]) %>% arrange(date, bodysite, Grp2, ASV)

    tmp_tb1$xx[tmp_tb1$date==dds[1]] <- 0
    tmp_tb1$yy[tmp_tb1$date==dds[1]] <- seq(sum(tmp_tb1$date==dds[1])) + (n_max - sum(tmp_tb1$date==dds[1]))/2
    
    tmp_tb1$xx[tmp_tb1$date==dds[2]] <- seq(sum(tmp_tb1$date==dds[2])) + (n_max-sum(tmp_tb1$date==dds[2]))/2
    tmp_tb1$yy[tmp_tb1$date==dds[2]] <- n_max*1.2
    
    tmp_tb1$xx[tmp_tb1$date==dds[3]] <- n_max*1.2
    tmp_tb1$yy[tmp_tb1$date==dds[3]] <- seq(sum(tmp_tb1$date==dds[3])) + (n_max - sum(tmp_tb1$date==dds[3]))/2
    
    tmp_tb1_sum <- tmp_tb1 %>% group_by(date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = factor(date, levels = dds))  %>% filter(!is.na(Grp2))
    
    bb_text <- tmp_tb1 %>% group_by(date, bodysite) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = range(yy) %>% mean)
    
    tmp_tb2 <- asv_mm_day0_filt_v %>% mutate(xx = seq(n()) + (n_max-n())/2, yy = -5)
    tmp_tb2$Grp2 %>% table
    mm_text <- tmp_tb2 %>% group_by(Grp2) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = -5) %>% mutate(Pct = round(N/sum(N)*100,1), Label = paste0(gsub("Vagina.", "", Grp2), ": ", N, "ASV (", Pct, "%)"))
    
    tmp_tb3 <- merge(tmp_tb1, tmp_tb2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    bb_col <- c("#F8766D","#00BA38","#619CFF")
    names(bb_col) <- c("Feces", "Forearm", "Mouth")
    
    mm_col <- c('purple','black','#F8766D', 'orange', '#00BA38', 'grey')
    names(mm_col) <- c("Vagina.Only", "Vagina.Feces", "Vagina.Feces.Others", "Vagina.Forearm", "Vagina.Forearm.Others", "Vagina.Others")
    p_list[[bm]] <- ggplot(data = tmp_tb1, aes(x = xx, y = yy)) +
        geom_segment(data = tmp_tb3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(aes(fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 15, size = 3) +
        #geom_label(data = bb_text, aes(label = N), size = 14/.pt) +
        #geom_label_repel(data = mm_text, aes(label = Label), size = 7/.pt, ) +
        annotate("text", x = -n_max*0.05, y = n_max/2, label = paste0("Baby sites at ", dds[1]), angle = 90, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = n_max*1.25, label = paste0("Baby sites at ", dds[2]), size = 14/.pt ) +
        annotate("text", x = n_max*1.25, y = n_max/2, label = paste0("Baby sites at ", dds[3]), angle = 270, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = -n_max*0.05, label = paste0("Maternal Vaginal Source"), size = 14/.pt ) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values= mm_col, labels = function(x){mm_text$Label[match(x, mm_text$Grp2)]}) +
        theme_bw(base_size = 15) + theme(aspect.ratio = 1, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Vaginal Source", title = bm)
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_vagina_tp0.pdf"), width = 21, useDingbats = F)
```

###### Plot baby source at day 0, 2, 7
```{r}
dds = c("Day_0", "Day_2-3", "Day_7")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

n_max <- asv_bb_tmp %>% separate(sample, into = paste0("V", seq(3)), sep = "\\.") %>% group_by(V2, V3) %>% summarise(N=n()) %>% pull(N) %>% max(c(., nrow(asv_mm_day0_filt_v)))
p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3], bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1]) %>% arrange(date, bodysite, Grp2, ASV)

    tmp_tb1$xx[tmp_tb1$date==dds[1]] <- 0
    tmp_tb1$yy[tmp_tb1$date==dds[1]] <- seq(sum(tmp_tb1$date==dds[1])) + (n_max - sum(tmp_tb1$date==dds[1]))/2
    
    tmp_tb1$xx[tmp_tb1$date==dds[2]] <- seq(sum(tmp_tb1$date==dds[2])) + (n_max-sum(tmp_tb1$date==dds[2]))/2
    tmp_tb1$yy[tmp_tb1$date==dds[2]] <- n_max*1.2
    
    tmp_tb1$xx[tmp_tb1$date==dds[3]] <- n_max*1.2
    tmp_tb1$yy[tmp_tb1$date==dds[3]] <- seq(sum(tmp_tb1$date==dds[3])) + (n_max - sum(tmp_tb1$date==dds[3]))/2
    
    tmp_tb1_sum <- tmp_tb1 %>% group_by(date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = factor(date, levels = dds))  %>% filter(!is.na(Grp2))
    
    bb_text <- tmp_tb1 %>% group_by(date, bodysite) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = range(yy) %>% mean)
    
    tmp_tb2 <- asv_mm_day0_filt_v %>% mutate(xx = seq(n()) + (n_max-n())/2, yy = -5)
    tmp_tb2$Grp2 %>% table
    mm_text <- tmp_tb2 %>% group_by(Grp2) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = -5) %>% mutate(Pct = round(N/sum(N)*100,1), Label = paste0(gsub("Vagina.", "", Grp2), ": ", N, "ASV (", Pct, "%)"))
    
    tmp_tb3 <- merge(tmp_tb1, tmp_tb2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    
    p_list[[bm]] <- ggplot(data = tmp_tb1, aes(x = xx, y = yy)) +
        geom_segment(data = tmp_tb3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(aes(fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 15, size = 3) +
        #geom_label(data = bb_text, aes(label = N), size = 14/.pt) +
        #geom_label_repel(data = mm_text, aes(label = Label), size = 7/.pt, ) +
        annotate("text", x = -n_max*0.05, y = n_max/2, label = paste0("Baby sites at ", dds[1]), angle = 90, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = n_max*1.25, label = paste0("Baby sites at ", dds[2]), size = 14/.pt ) +
        annotate("text", x = n_max*1.25, y = n_max/2, label = paste0("Baby sites at ", dds[3]), angle = 270, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = -n_max*0.05, label = paste0("Maternal Vaginal Source"), size = 14/.pt ) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values= mm_col, labels = function(x){mm_text$Label[match(x, mm_text$Grp2)]}) +
        theme_bw(base_size = 15) + theme(aspect.ratio = 1, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Vaginal Source", title = bm)
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_vagina_tp1.pdf"), width = 21, useDingbats = F)
```
```{r}
dds = c("Day_0", "Day_2-3", "Day_7")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% 
        merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>%
        mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3] %>% factor(levels = c("Perinatal", dds)), 
               bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1],  
               xx = case_when(date==dds[1] ~ 2, date==dds[2] ~ 3, T ~ 4)) %>% 
        arrange(date, sample, Grp2, ASV) %>% 
        group_by(date) %>% mutate(yy = seq(n()))

    tmp_tb2 <- asv_mm_day0_filt_v %>% 
        arrange(Grp2, ASV) %>% 
        mutate(xx = 1, 
               yy = seq(n()) + (max(tmp_tb1$yy)-nrow(asv_mm_day0_filt_v))/2, 
               date = factor("Perinatal", levels = c("Perinatal", dds)))
    tmp_tb3 <- merge(tmp_tb2, tmp_tb1 %>% filter(date==dds[1], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    
    tmp_tb4 <- merge(tmp_tb1 %>% filter(date==dds[1], !is.na(Grp2)), tmp_tb1 %>% filter(date==dds[2], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    tmp_tb5 <- merge(tmp_tb1 %>% filter(date==dds[2], !is.na(Grp2)), tmp_tb1 %>% filter(date==dds[3], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    
    
    
    tmp_tb6 = rbind(tmp_tb3, tmp_tb4, tmp_tb5)
    
    p_list[[bm]] <- ggplot() +
        geom_segment(data = tmp_tb6, aes(x = xx.1, xend = xx.2, y = yy.1, yend = yy.2, color = Grp2), size = 0.3) +
        geom_point(data = tmp_tb1, aes(x = xx, y = yy, fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 16, size = 3) +
        theme_bw(base_size = 10) + theme(aspect.ratio = 0.4, panel.grid = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Vaginal Source", title = bm) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values = mm_col) +
        scale_x_continuous(labels = c("Moms", paste0("Baby Site at ", dds)))
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list, ncol = 1) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_vagina_tp1_long.pdf"), width = 9, useDingbats = F)
```

```{r}
dd = "Day_0"
asv_bb_tmp_2 <- asv_bb_tmp %>% filter(grepl(dd, sample)) %>% separate(sample, into = c("bodysite", "birthmode", "date"), sep = "\\.") %>%
    merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% 
    mutate(birthmode = factor(birthmode, levels =  c("Vag", "CSseed", "CS"))) 

bodysite = names(bb_col)
p_list <- list()
for (bb in bodysite){
    dat_tmp <- asv_bb_tmp_2 %>% filter(bodysite==bb) %>% arrange(birthmode, Grp2, ASV) %>%
        ungroup %>% mutate(xx = 1, yy = seq(n()), yy = ifelse(birthmode=="CSseed", yy+50, ifelse(birthmode=="CS", yy+100, yy))) 
    dat_tmp2 <- asv_mm_day0_filt_v %>% arrange(Grp2, ASV) %>% ungroup() %>%
        mutate(xx = 0, yy = seq(n()) + max(dat_tmp$yy)/2)
    dat_tmp3 <- merge(dat_tmp, dat_tmp2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    p_list[[bb]] <- ggplot() +
        geom_segment(data = dat_tmp3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(data = dat_tmp, aes(x =xx, y = yy, fill = birthmode), shape = 22, color = "transparent") +
        geom_point(data = dat_tmp2, aes(x =xx, y = yy, color = Grp2), shape = 15) +
        scale_color_manual(values = mm_col) +
        scale_fill_manual(values = c("Vag"="blue", "CSseed" = "green", "CS" = "red"), label = c("vaginal", "cesarean-seeded", "cesarean")) +
        theme_bw(base_size = 12) + theme(aspect.ratio = 1.5, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Birth Mode", color = "Maternal Vaginal Source", title = bb)
        
    print(p_list[[bb]])
}

wrap_plots(p_list) + plot_layout(guides = "collect") + plot_annotation(title = dd)& theme(legend.position = "bottom", legend.box = "vertical")

ggsave("tmp_figs/asv_shared_mm_vagina_day0_by_site.pdf", width = 9, useDingbats = F)



```

###### Summarize baby source
```{r}
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby")

asv_bb_tmp <- parallel::mclapply(mf_bb_wk %>% split(., list(.$date_sampling_category_days_continuous, .$body_site_corrected, .$birth_mode_ms)), function(x){ otu_baby_lst[[paste(x$body_site_corrected[1], x$birth_mode_ms[1], sep = ".")]] %>% as.data.frame %>% select(x$sample_name) %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T)}, mc.cores = np) %>% 
    do.call("rbind", .) %>% rownames_to_column(var = "sample") %>% separate(sample, into = c("date", "bodysite", "birthmode"), sep = "\\.", remove = F)

head(asv_bb_tmp)
asv_bb_tmp_sum <- asv_bb_tmp  %>% group_by(birthmode, date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = as.numeric(date), birthmode = factor(birthmode, levels = c("Vag", "CSseed", "CS"))) %>% ungroup

mm_col <- c('purple','black','#F8766D', 'orange', '#00BA38', 'grey')
names(mm_col) <- c("Vagina.Only", "Vagina.Feces", "Vagina.Feces.Others", "Vagina.Forearm", "Vagina.Forearm.Others", "Vagina.Others")
ggplot(asv_bb_tmp_sum %>% filter(!is.na(Grp2)), aes(date, Pct, color = Grp2)) +
    geom_point() +
    geom_line() +
    facet_grid(bodysite ~ birthmode, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    scale_color_manual(values = mm_col) +
    labs(x = "Days", y = "Percentage", color = "Maternal Vaginal Sources", title = "Percentage of ASVs in different baby body sites \nthat could be traced back to certain vaginal sources")
ggsave(paste0(fig_path, "asv_shared_mm_vagina_yr1.pdf"), width = 9, useDingbats = F)

ggplot(asv_bb_tmp_sum %>% filter(!is.na(Grp2), date<=7), aes(date, Pct, color = Grp2)) +
    geom_point() +
    geom_line() +
    facet_grid(bodysite ~ birthmode, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    scale_color_manual(values = mm_col) +
    labs(x = "Days", y = "Percentage", color = "Maternal Vaginal Sources", title = "Percentage of ASVs in different baby body sites \nthat could be traced back to certain vaginal sources")
ggsave(paste0(fig_path, "asv_shared_mm_vagina_wk1.pdf"), width = 9, useDingbats = F)

```

##### Maternal feces
```{r}
asv_mm_day0_filt_v <- asv_mm_day0_filt %>% filter(grepl("Feces", Grp)) %>% 
    mutate(Grp2 = case_when(Grp=="Feces" ~ "Feces.Only",
                            Grp=="Feces.Right_Areola" ~ "Feces.Others",
                            N_site <=2 ~ Grp,
                            grepl("Vagina.Feces.", Grp) ~ "Vagina.Feces.Others",
                            grepl("Feces.Forearm.", Grp) ~ "Feces.Forearm.Others",
                            T ~ "Feces.Others")) %>% 
    mutate(Grp2 = factor(Grp2, levels = c("Feces.Only", "Vagina.Feces", "Vagina.Feces.Others", "Feces.Forearm", "Feces.Forearm.Others", "Feces.Mouth", "Feces.Others"))) %>%
    ungroup %>% arrange(Grp2, ASV)
nrow(asv_mm_day0_filt_v)
asv_mm_day0_filt_v$Grp2 %>% table(useNA = "ifany")

bb_col <- c("#F8766D","#00BA38","#619CFF")
names(bb_col) <- c("Feces", "Forearm", "Mouth")

mm_col <- c('#F8766D', 'black', 'purple', '#00BA38','orange',  "#619CFF", 'grey')
names(mm_col) <- c("Feces.Only", "Vagina.Feces", "Vagina.Feces.Others", "Feces.Forearm", "Feces.Forearm.Others", "Feces.Mouth", "Feces.Others")
```
###### Plot baby source
```{r}

dds = c("Day_30", "Day_90", "Day_240")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

n_max <- asv_bb_tmp %>% separate(sample, into = paste0("V", seq(3)), sep = "\\.") %>% group_by(V2, V3) %>% summarise(N=n()) %>% pull(N) %>% max(c(., nrow(asv_mm_day0_filt_v)))
p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3], bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1]) %>% arrange(date, bodysite, Grp2, ASV)

    tmp_tb1$xx[tmp_tb1$date==dds[1]] <- 0
    tmp_tb1$yy[tmp_tb1$date==dds[1]] <- seq(sum(tmp_tb1$date==dds[1])) + (n_max - sum(tmp_tb1$date==dds[1]))/2
    
    tmp_tb1$xx[tmp_tb1$date==dds[2]] <- seq(sum(tmp_tb1$date==dds[2])) + (n_max-sum(tmp_tb1$date==dds[2]))/2
    tmp_tb1$yy[tmp_tb1$date==dds[2]] <- n_max*1.2
    
    tmp_tb1$xx[tmp_tb1$date==dds[3]] <- n_max*1.2
    tmp_tb1$yy[tmp_tb1$date==dds[3]] <- seq(sum(tmp_tb1$date==dds[3])) + (n_max - sum(tmp_tb1$date==dds[3]))/2
    
    tmp_tb1_sum <- tmp_tb1 %>% group_by(date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = factor(date, levels = dds))  %>% filter(!is.na(Grp2))
    
    bb_text <- tmp_tb1 %>% group_by(date, bodysite) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = range(yy) %>% mean)
    
    tmp_tb2 <- asv_mm_day0_filt_v %>% mutate(xx = seq(n()) + (n_max-n())/2, yy = -5)
    tmp_tb2$Grp2 %>% table
    mm_text <- tmp_tb2 %>% group_by(Grp2) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = -5) %>% mutate(Pct = round(N/sum(N)*100,1), Label = paste0(gsub("Feces.|Feces", "", Grp2), ": ", N, "ASV (", Pct, "%)"))
    
    tmp_tb3 <- merge(tmp_tb1, tmp_tb2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    
    p_list[[bm]] <- ggplot(data = tmp_tb1, aes(x = xx, y = yy)) +
        geom_segment(data = tmp_tb3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(aes(fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 15, size = 3) +
        #geom_label(data = bb_text, aes(label = N), size = 14/.pt) +
        #geom_label_repel(data = mm_text, aes(label = Label), size = 7/.pt, ) +
        annotate("text", x = -n_max*0.05, y = n_max/2, label = paste0("Baby sites at ", dds[1]), angle = 90, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = n_max*1.25, label = paste0("Baby sites at ", dds[2]), size = 14/.pt ) +
        annotate("text", x = n_max*1.25, y = n_max/2, label = paste0("Baby sites at ", dds[3]), angle = 270, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = -n_max*0.05, label = paste0("Maternal Fecal Source"), size = 14/.pt ) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values= mm_col, labels = function(x){mm_text$Label[match(x, mm_text$Grp2)]}) +
        theme_bw(base_size = 15) + theme(aspect.ratio = 1, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Fecal Source", title = bm)
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_feces_tp0.pdf"), width = 21, useDingbats = F)

```
###### Plot baby source day 0, 2, 7
```{r}

dds = c("Day_0", "Day_2-3", "Day_7")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

n_max <- asv_bb_tmp %>% separate(sample, into = paste0("V", seq(3)), sep = "\\.") %>% group_by(V2, V3) %>% summarise(N=n()) %>% pull(N) %>% max(c(., nrow(asv_mm_day0_filt_v)))
p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3], bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1]) %>% arrange(date, bodysite, Grp2, ASV)

    tmp_tb1$xx[tmp_tb1$date==dds[1]] <- 0
    tmp_tb1$yy[tmp_tb1$date==dds[1]] <- seq(sum(tmp_tb1$date==dds[1])) + (n_max - sum(tmp_tb1$date==dds[1]))/2
    
    tmp_tb1$xx[tmp_tb1$date==dds[2]] <- seq(sum(tmp_tb1$date==dds[2])) + (n_max-sum(tmp_tb1$date==dds[2]))/2
    tmp_tb1$yy[tmp_tb1$date==dds[2]] <- n_max*1.2
    
    tmp_tb1$xx[tmp_tb1$date==dds[3]] <- n_max*1.2
    tmp_tb1$yy[tmp_tb1$date==dds[3]] <- seq(sum(tmp_tb1$date==dds[3])) + (n_max - sum(tmp_tb1$date==dds[3]))/2
    
    tmp_tb1_sum <- tmp_tb1 %>% group_by(date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = factor(date, levels = dds))  %>% filter(!is.na(Grp2))
    
    bb_text <- tmp_tb1 %>% group_by(date, bodysite) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = range(yy) %>% mean)
    
    tmp_tb2 <- asv_mm_day0_filt_v %>% mutate(xx = seq(n()) + (n_max-n())/2, yy = -5)
    tmp_tb2$Grp2 %>% table
    mm_text <- tmp_tb2 %>% group_by(Grp2) %>% summarise(N = n(), xx = range(xx) %>% mean, yy = -5) %>% mutate(Pct = round(N/sum(N)*100,1), Label = paste0(gsub("Feces.|Feces", "", Grp2), ": ", N, "ASV (", Pct, "%)"))
    
    tmp_tb3 <- merge(tmp_tb1, tmp_tb2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    
    p_list[[bm]] <- ggplot(data = tmp_tb1, aes(x = xx, y = yy)) +
        geom_segment(data = tmp_tb3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(aes(fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 15, size = 3) +
        #geom_label(data = bb_text, aes(label = N), size = 14/.pt) +
        #geom_label_repel(data = mm_text, aes(label = Label), size = 7/.pt, ) +
        annotate("text", x = -n_max*0.05, y = n_max/2, label = paste0("Baby sites at ", dds[1]), angle = 90, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = n_max*1.25, label = paste0("Baby sites at ", dds[2]), size = 14/.pt ) +
        annotate("text", x = n_max*1.25, y = n_max/2, label = paste0("Baby sites at ", dds[3]), angle = 270, size = 14/.pt ) +
        annotate("text", x = n_max/2, y = -n_max*0.05, label = paste0("Maternal Fecal Source"), size = 14/.pt ) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values= mm_col, labels = function(x){mm_text$Label[match(x, mm_text$Grp2)]}) +
        theme_bw(base_size = 15) + theme(aspect.ratio = 1, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Fecal Source", title = bm)
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_feces_tp1.pdf"), width = 21, useDingbats = F)

```
```{r}
dds = c("Day_0", "Day_2-3", "Day_7")
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby", date_sampling_category_days %in% dds)
asv_bb_tmp <- list()
for (dd in dds){
    mf_tmp_lst <- mf_bb_wk %>% filter(date_sampling_category_days==dd) %>% split(., list(.$body_site_corrected, .$birth_mode_ms))
    asv_bb_tmp[[dd]] <- lapply(names(mf_tmp_lst), function(x){otu_baby_lst[[x]][, mf_tmp_lst[[x]]$sample_name] %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% mutate(sample = paste(x, dd, sep = '.'))}) %>% do.call("rbind", .)
        
}
asv_bb_tmp <- do.call("rbind", asv_bb_tmp)

p_list <- list()
for (bm in c("Vag", "CSseed", "CS")){
    #break
    tmp_tb1 <- asv_bb_tmp %>% filter(grepl(paste0("\\<", bm, "\\>"), sample)) %>% 
        merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>%
        mutate(date = str_split(sample, pattern = "\\.", simplify = T)[, 3] %>% factor(levels = c("Perinatal", dds)), 
               bodysite = str_split(sample, pattern = "\\.", simplify = T)[, 1],  
               xx = case_when(date==dds[1] ~ 2, date==dds[2] ~ 3, T ~ 4)) %>% 
        arrange(date, sample, Grp2, ASV) %>% 
        group_by(date) %>% mutate(yy = seq(n()))

    tmp_tb2 <- asv_mm_day0_filt_v %>% 
        arrange(Grp2, ASV) %>% 
        mutate(xx = 1, 
               yy = seq(n()) + (max(tmp_tb1$yy)-nrow(asv_mm_day0_filt_v))/2, 
               date = factor("Perinatal", levels = c("Perinatal", dds)))
    tmp_tb3 <- merge(tmp_tb2, tmp_tb1 %>% filter(date==dds[1], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    
    tmp_tb4 <- merge(tmp_tb1 %>% filter(date==dds[1], !is.na(Grp2)), tmp_tb1 %>% filter(date==dds[2], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    tmp_tb5 <- merge(tmp_tb1 %>% filter(date==dds[2], !is.na(Grp2)), tmp_tb1 %>% filter(date==dds[3], !is.na(Grp2)), by = c("ASV", "Grp2"), suffixes = c(".1", ".2")) %>% select(starts_with("xx"), starts_with("yy"), Grp2)
    
    
    
    tmp_tb6 = rbind(tmp_tb3, tmp_tb4, tmp_tb5)
    
    p_list[[bm]] <- ggplot() +
        geom_segment(data = tmp_tb6, aes(x = xx.1, xend = xx.2, y = yy.1, yend = yy.2, color = Grp2), size = 0.3) +
        geom_point(data = tmp_tb1, aes(x = xx, y = yy, fill = bodysite), colour = "transparent", shape = 22, size = 3) +
        geom_point(data = tmp_tb2, aes(x = xx, y = yy, color = Grp2), shape = 16, size = 3) +
        theme_bw(base_size = 10) + theme(aspect.ratio = 0.4, panel.grid = element_blank(), axis.line.y = element_blank(), axis.text.y = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Body Site", color = "Maternal Fecal Source", title = bm) +
        scale_fill_manual(values = bb_col) +
        scale_color_manual(values = mm_col) +
        scale_x_continuous(labels = c("Moms", paste0("Baby Site at ", dds)))
        
    print(p_list[[bm]])
    
    # ggplot(tmp_tb1_sum, aes(date, Pct, color = Grp2)) +
    #     geom_line(aes(group = Grp2)) +
    #     facet_grid(.~bodysite)
}

wrap_plots(p_list, ncol = 1) + plot_layout(guides = "collect") & theme(legend.position = "bottom", legend.box = "vertical")
ggsave(paste0(fig_path, "asv_shared_mm_feces_tp1_long.pdf"), width = 9, useDingbats = F)
```

```{r}
dd = "Day_0"
asv_bb_tmp_2 <- asv_bb_tmp %>% filter(grepl(dd, sample)) %>% separate(sample, into = c("bodysite", "birthmode", "date"), sep = "\\.") %>%
    merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T) %>% 
    mutate(birthmode = factor(birthmode, levels =  c("Vag", "CSseed", "CS"))) 

bodysite = names(bb_col)
p_list <- list()
for (bb in bodysite){
    dat_tmp <- asv_bb_tmp_2 %>% filter(bodysite==bb) %>% arrange(birthmode, Grp2, ASV) %>%
        ungroup %>% mutate(xx = 1, yy = seq(n()), yy = ifelse(birthmode=="CSseed", yy+50, ifelse(birthmode=="CS", yy+100, yy))) 
    dat_tmp2 <- asv_mm_day0_filt_v %>% arrange(Grp2, ASV) %>% ungroup() %>%
        mutate(xx = 0, yy = seq(n()) + max(dat_tmp$yy)/2)
    dat_tmp3 <- merge(dat_tmp, dat_tmp2, by = c("ASV", "Grp2"), suffixes = c(".bb", ".mm"))
    
    p_list[[bb]] <- ggplot() +
        geom_segment(data = dat_tmp3, aes(x = xx.mm, xend = xx.bb, y = yy.mm, yend = yy.bb, color = Grp2), size = 0.3) +
        geom_point(data = dat_tmp, aes(x =xx, y = yy, fill = birthmode), shape = 22, color = "transparent") +
        geom_point(data = dat_tmp2, aes(x =xx, y = yy, color = Grp2), shape = 15) +
        scale_color_manual(values = mm_col) +
        scale_fill_manual(values = c("Vag"="blue", "CSseed" = "green", "CS" = "red"), label = c("vaginal", "cesarean-seeded", "cesarean")) +
        theme_bw(base_size = 12) + theme(aspect.ratio = 1.5, panel.grid = element_blank(), axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) +
        labs(x = "", y = "", fill = "Baby Birth Mode", color = "Maternal Fecal Source", title = bb)
        
    print(p_list[[bb]])
}

wrap_plots(p_list) + plot_layout(guides = "collect") + plot_annotation(title = dd)& theme(legend.position = "bottom", legend.box = "vertical")

ggsave("tmp_figs/asv_shared_mm_feces_day0_by_site.pdf", width = 9, useDingbats = F)



```

###### Summarize baby source
```{r}
mf_bb_wk <- mf_wk %>% filter(mom_baby=="Baby")

asv_bb_tmp <- parallel::mclapply(mf_bb_wk %>% split(., list(.$date_sampling_category_days_continuous, .$body_site_corrected, .$birth_mode_ms)), function(x){ otu_baby_lst[[paste(x$body_site_corrected[1], x$birth_mode_ms[1], sep = ".")]] %>% as.data.frame %>% select(x$sample_name) %>% filter(rowSums(.)>0) %>% rownames_to_column(var = "ASV") %>% select(ASV) %>% merge(., asv_mm_day0_filt_v, by = "ASV", all.x = T)}, mc.cores = np) %>% 
    do.call("rbind", .) %>% rownames_to_column(var = "sample") %>% separate(sample, into = c("date", "bodysite", "birthmode"), sep = "\\.", remove = F)

head(asv_bb_tmp)
asv_bb_tmp_sum <- asv_bb_tmp  %>% group_by(birthmode, date, bodysite, Grp2) %>% summarise(N = n()) %>% mutate(Pct = round(N/sum(N), 3), date = as.numeric(date), birthmode = factor(birthmode, levels = c("Vag", "CSseed", "CS"))) %>% ungroup


ggplot(asv_bb_tmp_sum %>% filter(!is.na(Grp2)), aes(date, Pct, color = Grp2)) +
    geom_point() +
    geom_line() +
    facet_grid(bodysite ~ birthmode, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    scale_color_manual(values = mm_col) +
    labs(x = "Days", y = "Percentage", color = "Maternal Fecal Sources", title = "Percentage of ASVs in different baby body sites \nthat could be traced back to certain fecal sources")
ggsave(paste0(fig_path,  "asv_shared_mm_feces_yr1.pdf"), width = 9, useDingbats = F)

ggplot(asv_bb_tmp_sum %>% filter(!is.na(Grp2), date<=7), aes(date, Pct, color = Grp2)) +
    geom_point() +
    geom_line() +
    facet_grid(bodysite ~ birthmode, scales = "free_y") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    scale_color_manual(values = mm_col) +
    labs(x = "Days", y = "Percentage", color = "Maternal Fecal Sources", title = "Percentage of ASVs in different baby body sites \nthat could be traced back to certain fecal sources")
ggsave(paste0(fig_path,  "asv_shared_mm_feces_wk1.pdf"), width = 9, useDingbats = F)

```

### Individual babies
```{r}
## Maternal ASV paranatal
mf_mm_day0 <- mf_wk %>% filter((mom_baby=="Mom" & as.numeric(date_sampling_category_days_continuous)<=2)|body_site_corrected=="Gauze")
mf_mm_day0$body_site_corrected[mf_mm_day0$body_site_corrected=="Gauze"] = "Vagina"
mf_mm_day0$birth_mode_ms[mf_mm_day0$birth_mode_ms=="CSself"] = "CSseed"

mf_mm_day0_lst <- mf_mm_day0 %>% split(., list(.$body_site_corrected, .$birth_mode_ms))

otu_mm_day0_lst <- parallel::mclapply(mf_mm_day0_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np) # only include otu existed in more than 10% of samples

## Baby ASVs
mf_bb_lst <- mf_wk %>% filter(mom_baby=="Baby") %>% split(., list(.$body_site_corrected, .$birth_mode_ms))

otu_baby_lst <- parallel::mclapply(mf_bb_lst, function(x){prune_samples(x$sample_name, phylo_wk) %>% otu_table %>% as.matrix() %>% as.data.frame %>% filter(rowSums(.>0)>0.1*ncol(.))}, mc.cores = np)
```

```{r}
ss <- c("Vagina", "Feces", "Mouth", "Forearm", "Right_Areola", "Nose")

asv_mm_day0_all <- lapply(seq_along(otu_mm_day0_lst), function(x){data.frame(ASV = rownames(otu_mm_day0_lst[[x]]), Bodysite = names(otu_mm_day0_lst)[[x]])}) %>% do.call("rbind",.) %>% separate(Bodysite, c("bodysite", "birthmode"), sep = "\\.")

asv_mm_day0_filt <- asv_mm_day0_all %>% mutate(bodysite = factor(bodysite, levels = ss)) %>% arrange(birthmode, bodysite, ASV) %>% 
    group_by(birthmode, ASV) %>%
    summarise(Grp = paste(bodysite, collapse = "."), N_site = n())
```
#### Maternal vagina
```{r}
asv_mm_day0_filt_v <- asv_mm_day0_filt %>% filter(grepl("Vagina", Grp)) %>%
    mutate(Grp2 = case_when(Grp=="Vagina" ~ "Vagina.Only",
                            grepl("Feces", Grp) ~ "Vagina.Feces.0+Sites",
                            T ~ "Vagina.Others")) %>%
    mutate(Grp2 = factor(Grp2, levels = c("Vagina.Only", "Vagina.Feces.0+Sites", "Vagina.Others"))) %>%
    ungroup %>% arrange(birthmode, Grp2, ASV)
nrow(asv_mm_day0_filt_v)
asv_mm_day0_filt_v$Grp2 %>% table(useNA = "ifany")

bb_col <- c("#F8766D","#00BA38","#619CFF")
names(bb_col) <- c("Feces", "Forearm", "Mouth")

mm_col <- c('purple','#F8766D', 'orange')
names(mm_col) <- c("Vagina.Only", "Vagina.Feces.0+Sites", "Vagina.Others")
```

```{r}
asv_bb_tmp <- parallel::mclapply(seq_along(otu_baby_lst), function(x){otu_baby_lst[[x]] %>% rownames_to_column(var = "ASV") %>% pivot_longer(-1, names_to = "sample_name", values_to = "count") %>% filter(count>0) %>% merge(., asv_mm_day0_filt_v %>% filter(birthmode==(names(otu_baby_lst)[[x]] %>% str_split(pattern = "\\.", simplify = T))[2]) %>% select(ASV, Grp2), by = "ASV", all.x = T)}, mc.cores = np) %>% do.call("rbind", .)

asv_bb_tmp_2 <- asv_bb_tmp %>% merge(., 
                                     mf_wk %>% select(sample_name, date_sampling_category_days_continuous, body_site_corrected, birth_mode_ms), 
                                     by = "sample_name", all.x = T) %>%
    mutate(date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous))
```
```{r}
asv_bb_tmp_2_sum <- asv_bb_tmp_2 %>% group_by(birth_mode_ms, body_site_corrected, date_sampling_category_days_continuous, sample_name, Grp2) %>% summarise(N_asv = length(unique(ASV)), Rel_a = sum(count)/5000) %>% mutate(Pct_asv = round(N_asv/sum(N_asv), 3))

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2), date_sampling_category_days_continuous==0), aes(x = birth_mode_ms, y = Rel_a, color = birth_mode_ms)) +
    geom_boxplot() +
    facet_grid(body_site_corrected ~ Grp2) 

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% mutate(birth_mode_ms = factor(birth_mode_ms, levels = c("Vag", "CSseed", "CS"))), 
       aes(x = date_sampling_category_days_continuous, y = Rel_a, color = Grp2)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = Grp2), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ birth_mode_ms) +
    scale_x_continuous(limits = c(0,30)) +
    scale_color_manual(values = mm_col) +
    scale_fill_manual(values = mm_col) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Maternal Vaginal Source", fill = "Maternal Vaginal Source", title = "The abundance of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal vaginal source")

## Generate statistical results
asv_bb_tmp_2_sum_stat <- asv_bb_tmp_2_sum %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous) %>% filter(!is.na(Grp2), length(unique(birth_mode_ms))>=2) %>% dunn_test(data = ., Rel_a ~ birth_mode_ms, p.adjust.method = "none", detailed = T) %>% mutate(p.adj.signif = NULL) %>% ungroup
asv_bb_tmp_2_sum_stat$p.adj = p.adjust(asv_bb_tmp_2_sum_stat$p, method = "fdr")

## Generate group means, etc.
asv_bb_tmp_2_sum_means <- asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous, birth_mode_ms) %>% summarise(mean = Hmisc::smean.cl.boot(Rel_a) %>% paste(collapse = ",")) %>% ungroup %>% separate(mean, into = c("mean", "lower", "upper"), sep = ",") %>% mutate(across(mean:upper, ~round(as.numeric(.x), 3))) %>% arrange(body_site_corrected, Grp2, date_sampling_category_days_continuous, mean) %>% ungroup

Tmp <- lapply(list(asv_bb_tmp_2_sum_stat, asv_bb_tmp_2_sum_means), function(x){split(x, list(x$body_site_corrected, x$Grp2, x$date_sampling_category_days_continuous))})

for (i in seq(length(Tmp[[1]]))){
    if (length(Tmp[[2]][[i]]$birth_mode_ms)<=1){next}
    Tmp[[2]][[i]]$sig_letters = (Tmp[[1]][[i]] %>% mutate(names = ifelse(estimate<0, paste(group2, group1, sep ="-"), paste(group1, group2, sep = "-")), p.adj = set_names(p.adj, nm = names)) %>% pull(p.adj) %>% multcompLetters(threshold = 0.1))$Letters[Tmp[[2]][[i]]$birth_mode_ms]
}

asv_bb_tmp_2_sum_means <- data.table::rbindlist(Tmp[[2]], fill = T)
    
ggplot(asv_bb_tmp_2_sum_means %>% filter(date_sampling_category_days_continuous<=30), aes(x = log2(date_sampling_category_days_continuous+1), y = mean, color = birth_mode_ms)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = birth_mode_ms), alpha = 0.3, color = "transparent") +
    geom_point(size = 1) +
    geom_line() +
    geom_label_repel(data = asv_bb_tmp_2_sum_means %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous) %>% filter(date_sampling_category_days_continuous<=30, length(unique(sig_letters))>1), aes(label = sig_letters), size = 7/.pt) +
    facet_grid(body_site_corrected ~ Grp2) +
    scale_x_continuous(breaks = log2(c(0,1,2,7,14,21,28)+1), labels = c(0,1,2,7,14,21, 28)) +
    scale_color_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    scale_fill_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8, panel.grid.minor = element_blank()) +
    labs(x = "Days", y = "Relative Abundance", color = "Birth mode", fill = "Birth mode", title = "The abundance of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal vaginal source")
ggsave(paste0(fig_path, "sum_asv_abundance_mm_vagina_m1_2.pdf"), width = 10, useDingbats = F)


ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% mutate(birth_mode_ms = factor(birth_mode_ms, levels = c("Vag", "CSseed", "CS"))), 
       aes(x = date_sampling_category_days_continuous, y = Pct_asv, color = Grp2)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = Grp2), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ birth_mode_ms) +
    scale_x_continuous(limits = c(0,30)) +
    scale_color_manual(values = mm_col) +
    scale_fill_manual(values = mm_col) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Maternal Vaginal Source", fill = "Maternal Vaginal Source", title = "The percentage of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal vaginal source")
ggsave(paste0(fig_path, "sum_asv_percentage_mm_vagina_m1_1.pdf"), width = 10, useDingbats = F)

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)), aes(x = date_sampling_category_days_continuous, y = Pct_asv, color = birth_mode_ms)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = birth_mode_ms), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ Grp2) +
    scale_x_continuous(limits = c(0,30)) +
    scale_color_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    scale_fill_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Birth mode", fill = "Birth mode", title = "The percentage of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal vaginal source")

ggsave(paste0(fig_path, "sum_asv_percentage_mm_vagina_m1_2.pdf"), width = 10, useDingbats = F)
```

#### Maternal feces
```{r}
asv_mm_day0_filt_v <- asv_mm_day0_filt %>% filter(grepl("Feces", Grp)) %>% 
    mutate(Grp2 = case_when(Grp=="Feces" ~ "Feces.Only",
                            grepl("Vagina.", Grp) ~ "Vagina.Feces.0+Sites",
                            T ~ "Feces.Others")) %>% 
    mutate(Grp2 = factor(Grp2, levels = c("Feces.Only", "Vagina.Feces.0+Sites", "Feces.Others"))) %>%
    ungroup %>% arrange(birthmode, Grp2, ASV)
nrow(asv_mm_day0_filt_v)
asv_mm_day0_filt_v$Grp2 %>% table(useNA = "ifany")

bb_col <- c("#F8766D","#00BA38","#619CFF")
names(bb_col) <- c("Feces", "Forearm", "Mouth")

mm_col <- c('#F8766D', 'purple', "#619CFF")
names(mm_col) <- c("Feces.Only", "Vagina.Feces.0+Sites", "Feces.Others")


```

```{r}
asv_bb_tmp <- parallel::mclapply(seq_along(otu_baby_lst), function(x){otu_baby_lst[[x]] %>% rownames_to_column(var = "ASV") %>% pivot_longer(-1, names_to = "sample_name", values_to = "count") %>% filter(count>0) %>% merge(., asv_mm_day0_filt_v %>% filter(birthmode==(names(otu_baby_lst)[[x]] %>% str_split(pattern = "\\.", simplify = T))[2]) %>% select(ASV, Grp2), by = "ASV", all.x = T)}, mc.cores = np) %>% do.call("rbind", .)

asv_bb_tmp_2 <- asv_bb_tmp %>% merge(., 
                                     mf_wk %>% select(sample_name, date_sampling_category_days_continuous, body_site_corrected, birth_mode_ms), 
                                     by = "sample_name", all.x = T) %>%
    mutate(date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous))

asv_bb_tmp_2_sum <- asv_bb_tmp_2 %>% group_by(birth_mode_ms, body_site_corrected, date_sampling_category_days_continuous, sample_name, Grp2) %>% summarise(N_asv = length(unique(ASV)), Rel_a = sum(count)/5000) %>% mutate(Pct_asv = round(N_asv/sum(N_asv), 3))


ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2), date_sampling_category_days_continuous==0), aes(x = birth_mode_ms, y = Rel_a, color = birth_mode_ms)) +
    geom_boxplot() +
    facet_grid(body_site_corrected ~ Grp2) 

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2), date_sampling_category_days_continuous==0), aes(x = birth_mode_ms, y = Pct_asv, color = birth_mode_ms)) +
    geom_boxplot() +
    facet_grid(body_site_corrected ~ Grp2) 

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% mutate(birth_mode_ms = factor(birth_mode_ms, levels = c("Vag", "CSseed", "CS"))), 
       aes(x = date_sampling_category_days_continuous, y = Rel_a, color = Grp2)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = Grp2), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ birth_mode_ms) +
    scale_x_continuous(limits = c(0,30)) +
    scale_color_manual(values = mm_col) +
    scale_fill_manual(values = mm_col) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Maternal Fecal Source", fill = "Maternal Fecal Source", title = "The abundance of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal fecal source")
ggsave(paste0(fig_path, "sum_asv_abundance_mm_feces_m1_1.pdf"), width = 10, useDingbats = F)


## Generate statistical results
asv_bb_tmp_2_sum_stat <- asv_bb_tmp_2_sum %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous) %>% filter(!is.na(Grp2), length(unique(birth_mode_ms))>=2) %>% dunn_test(data = ., Rel_a ~ birth_mode_ms, p.adjust.method = "none", detailed = T) %>% mutate(p.adj.signif = NULL) %>% ungroup
asv_bb_tmp_2_sum_stat$p.adj = p.adjust(asv_bb_tmp_2_sum_stat$p, method = "fdr")

## Generate group means, etc.
asv_bb_tmp_2_sum_means <- asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous, birth_mode_ms) %>% summarise(mean = Hmisc::smean.cl.boot(Rel_a) %>% paste(collapse = ",")) %>% ungroup %>% separate(mean, into = c("mean", "lower", "upper"), sep = ",") %>% mutate(across(mean:upper, ~round(as.numeric(.x), 3))) %>% arrange(body_site_corrected, Grp2, date_sampling_category_days_continuous, mean) %>% ungroup

Tmp <- lapply(list(asv_bb_tmp_2_sum_stat, asv_bb_tmp_2_sum_means), function(x){split(x, list(x$body_site_corrected, x$Grp2, x$date_sampling_category_days_continuous))})

for (i in seq(length(Tmp[[1]]))){
    if (length(Tmp[[2]][[i]]$birth_mode_ms)<=1){next}
    Tmp[[2]][[i]]$sig_letters = (Tmp[[1]][[i]] %>% mutate(names = ifelse(estimate<0, paste(group2, group1, sep ="-"), paste(group1, group2, sep = "-")), p.adj = set_names(p.adj, nm = names)) %>% pull(p.adj) %>% multcompLetters(threshold = 0.1))$Letters[Tmp[[2]][[i]]$birth_mode_ms]
}

asv_bb_tmp_2_sum_means <- data.table::rbindlist(Tmp[[2]], fill = T)
    
ggplot(asv_bb_tmp_2_sum_means %>% filter(date_sampling_category_days_continuous<=30), aes(x = log2(date_sampling_category_days_continuous+1), y = mean, color = birth_mode_ms)) +
    geom_ribbon(aes(ymin = lower, ymax = upper, fill = birth_mode_ms), alpha = 0.3, color = "transparent") +
    geom_point(size = 1) +
    geom_line() +
    geom_label_repel(data = asv_bb_tmp_2_sum_means %>% group_by(body_site_corrected, Grp2, date_sampling_category_days_continuous) %>% filter(date_sampling_category_days_continuous<=30, length(unique(sig_letters))>1), aes(label = sig_letters), size = 7/.pt) +
    facet_grid(body_site_corrected ~ Grp2) +
    scale_x_continuous(breaks = log2(c(0,1,2,7,14,21,28)+1), labels = c(0,1,2,7,14,21, 28)) +
    scale_color_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    scale_fill_manual(values = c("#D0352C", "#67AD57","#497AB4")) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8, panel.grid.minor = element_blank()) +
    labs(x = "Days", y = "Relative Abundance", color = "Birth mode", fill = "Birth mode", title = "The abundance of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal fecal source")

ggsave(paste0(fig_path, "sum_asv_abundance_mm_feces_m1_2.pdf"), width = 10, useDingbats = F)


ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)) %>% mutate(birth_mode_ms = factor(birth_mode_ms, levels = c("Vag", "CSseed", "CS"))), 
       aes(x = date_sampling_category_days_continuous, y = Pct_asv, color = Grp2)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = Grp2), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ birth_mode_ms) +
    scale_x_continuous(limits = c(0,30)) +
    scale_color_manual(values = mm_col) +
    scale_fill_manual(values = mm_col) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Maternal Fecal Source", fill = "Maternal Fecal Source", title = "The percentage of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal fecal source")
ggsave(paste0(fig_path, "sum_asv_percentage_mm_feces_m1_1.pdf"), width = 10, useDingbats = F)

ggplot(asv_bb_tmp_2_sum %>% filter(!is.na(Grp2)), aes(x = date_sampling_category_days_continuous, y = Pct_asv, color = birth_mode_ms)) +
    geom_point(size = 1, alpha = 0.5) +
    stat_summary(geom="ribbon", aes(fill = birth_mode_ms), fun.data=mean_cl_boot, fun.args = list(conf.int=0.95), alpha = 0.3, color = NA) +
    stat_summary(geom="line", fun = mean, size = 1) +
    facet_grid(body_site_corrected ~ Grp2) +
    scale_x_continuous(limits = c(0,30)) +
    #scale_color_manual(values = mm_col) +
    #scale_fill_manual(values = mm_col) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Days", y = "Relative Abundance", color = "Birth mode", fill = "Birth mode", title = "The percentage of ASVs in baby samples of different birth modes \nthat can be attributed to different maternal fecal source")

ggsave(paste0(fig_path, "sum_asv_percentage_mm_feces_m1_2.pdf"), width = 10, useDingbats = F)
```

#### Maternal vaginal.feces.0+sites
```{r}
# filter the maternal asv table to only include asv common in both vagina and feces
asv_mm_day0_filt_v <- asv_mm_day0_filt %>% filter(grepl("Vagina.Feces", Grp)) %>% ungroup %>% arrange(birthmode, ASV)
nrow(asv_mm_day0_filt_v)

# convert baby otu table into long format, add maternal ASV group, and filter those asv included in asv_mm_day0_filt_v
# since the otu table is rarefied at 5000 reads/sample, the relative abundance is simply the count/5000
asv_bb_tmp <- parallel::mclapply(seq_along(otu_baby_lst), function(x){otu_baby_lst[[x]] %>% rownames_to_column(var = "ASV") %>% pivot_longer(-1, names_to = "sample_name", values_to = "count") %>% filter(count>0) %>% merge(., asv_mm_day0_filt_v %>% filter(birthmode==(names(otu_baby_lst)[[x]] %>% str_split(pattern = "\\.", simplify = T))[2]) %>% select(ASV, Grp),by = "ASV", all.x = T)}, mc.cores = np) %>% do.call("rbind", .) %>% filter(!is.na(Grp))
    
# add metadata to the asv_bb_tmp
asv_bb_tmp_2 <- asv_bb_tmp %>% merge(., 
                                     mf_wk %>% select(sample_name, date_sampling_category_days_continuous, body_site_corrected, birth_mode_ms), 
                                     by = "sample_name", all.x = T) %>%
    mutate(date_sampling_category_days_continuous = as.numeric(date_sampling_category_days_continuous))
## only select day 0 samples
asv_bb_tmp_2_day0 <- asv_bb_tmp_2 %>% filter(date_sampling_category_days_continuous<=1)
```

```{r}
# Generate the matrix for 3 baby sites
asv_matrix <- asv_bb_tmp_2_day0 %>% split(., .$body_site_corrected) %>% lapply(function(x){x %>% group_by(ASV, birth_mode_ms) %>% summarise(count = mean(count)) %>% ungroup() %>% arrange(birth_mode_ms) %>% pivot_wider(id_cols = ASV, names_from = birth_mode_ms, values_from = count, values_fill = 0)})

get_heatmap_ss <- function(baby_site, row_cluster=NULL){
    ss_tmp = baby_site # the string of birth mode, ["CS", "Vag", "CSseed"]
    ## metadata
    ## create the matrix for heatmap
    otu_mat <- asv_matrix[[ss_tmp]] %>% column_to_rownames(var = "ASV") %>% select(Vag, CSseed, CS) %>%as.matrix
    ### convert to log scale
    otu_mat = log10(otu_mat/5000)
    ### convert na or Inf to be -5, a value that is beyond the actual data range
    otu_mat[otu_mat==-Inf] = -5
    otu_mat[is.na(otu_mat)] = -5

    ## color scheme for the heatmap cells
    mat_col_fun = circlize::colorRamp2(c(-5, -4, -3.3, -2.6, -1.9, -1.2, -0.5), c("grey60","#253494", "#2c7fb8", "#41b6c4", "#7fcdbb", "#c7e9b4", "#ffffcc"))
    
    row_labels = (tax_table(phylo_wk) %>% as.matrix() %>% as.data.frame())[rownames(otu_mat), ] %>% unite(col = "Taxa", Domain:Species, sep = ";")
    
    col_ha1 = columnAnnotation(Birth_Mode = colnames(otu_mat), 
                               col = list(Birth_Mode=c("CS" = "#D0352C", "CSseed" = "#67AD57", "Vag" = "#497AB4")), show_annotation_name = F, 
                               gp = gpar(fontsize = 6), 
                               annotation_legend_param = list(Birth_Mode = list(labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold"))))
    p1 <- Heatmap(otu_mat, 
                  
                  name = "Relative abundance",
                  heatmap_legend_param = list(at = c(-4, -3.3, -2.6, -1.9, -1.2, -0.5), labels = c("0.01%", "0.05%", "0.25%", "1.25%", "6.25%", "31.25%"),
                                              labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold")),
                  
                  show_column_names = F,
                  cluster_columns = F, 
                  row_labels = row_labels$Taxa,
                  
                  col = mat_col_fun,
                  
                  top_annotation = col_ha1,
                  
                  #row_dend_width = unit(15, "mm"),
                  
                  height = unit(0.2, "in")*dim(otu_mat)[1],
                  width = unit(3, "in"),
                  column_title = ss_tmp)
    
    return(p1)
}

pdf(paste0(fig_path, "compare_asv_avg_mm_vagina.feces_bb_feces.pdf"), width = 21, height = (asv_matrix[["Feces"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss("Feces"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()

pdf(paste0(fig_path, "compare_asv_avg_mm_vagina.feces_bb_skin.pdf"), width = 21, height = (asv_matrix[["Forearm"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss("Forearm"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()

pdf(paste0(fig_path, "compare_asv_avg_mm_vagina.feces_bb_mouth.pdf"), width = 21, height = (asv_matrix[["Mouth"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss("Mouth"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()
```

```{r}
# Generate the matrix for 3 baby sites
asv_matrix <- asv_bb_tmp_2_day0 %>% split(., .$body_site_corrected) %>% lapply(function(x){x %>% group_by(birth_mode_ms) %>% mutate(N_sample = length(unique(sample_name))) %>% group_by(ASV, birth_mode_ms) %>% summarise(Pct = round(length(unique(sample_name))/N_sample[1], 3)) %>% ungroup() %>% arrange(birth_mode_ms) %>% pivot_wider(id_cols = ASV, names_from = birth_mode_ms, values_from = Pct, values_fill = 0)})

get_heatmap_ss_2 <- function(baby_site, row_cluster=NULL){
    ss_tmp = baby_site # the string of birth mode, ["CS", "Vag", "CSseed"]
    ## metadata
    ## create the matrix for heatmap
    otu_mat <- asv_matrix[[ss_tmp]] %>% column_to_rownames(var = "ASV") %>% select(Vag, CSseed, CS) %>%as.matrix

    ## color scheme for the heatmap cells
    row_labels = (tax_table(phylo_wk) %>% as.matrix() %>% as.data.frame())[rownames(otu_mat), ] %>% unite(col = "Taxa", Domain:Species, sep = ";")
    
    col_ha1 = columnAnnotation(Birth_Mode = colnames(otu_mat), 
                               col = list(Birth_Mode=c("CS" = "#D0352C", "CSseed" = "#67AD57", "Vag" = "#497AB4")), show_annotation_name = F, 
                               gp = gpar(fontsize = 6), 
                               annotation_legend_param = list(Birth_Mode = list(labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold"))))
    p1 <- Heatmap(otu_mat, 
                  
                  name = "Prevalence",
                  heatmap_legend_param = list(at = c(0.1, 0.3, 0.5, 0.7, 0.9), labels = c("10%", "30%", "50%", "70%", "90%"),
                                             labels_gp = gpar(fontsize = 6), title_gp = gpar(fontsize = 7, fontface = "bold")),
                  
                  show_column_names = F,
                  cluster_columns = F, 
                  row_labels = row_labels$Taxa,
                  

                  top_annotation = col_ha1,
                  
                  #row_dend_width = unit(15, "mm"),
                  
                  height = unit(0.2, "in")*dim(otu_mat)[1],
                  width = unit(3, "in"),
                  column_title = ss_tmp)
    
    return(p1)
}

pdf(paste0(fig_path, "compare_asv_prev_mm_vagina.feces_bb_feces.pdf"), width = 21, height = (asv_matrix[["Feces"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss_2("Feces"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()

pdf(paste0(fig_path, "compare_asv_prev_mm_vagina.feces_bb_skin.pdf"), width = 21, height = (asv_matrix[["Forearm"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss_2("Forearm"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()

pdf(paste0(fig_path, "compare_asv_prev_mm_vagina.feces_bb_mouth.pdf"), width = 21, height = (asv_matrix[["Mouth"]] %>% nrow())*0.2*1.5, useDingbats = F)
draw(get_heatmap_ss_2("Mouth"), heatmap_legend_side = "left", annotation_legend_side = "left")
dev.off()
```